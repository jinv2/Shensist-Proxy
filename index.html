<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¥æ€åº­ Â· æ™ºä¿¡ç»ˆç«¯</title>
    <link rel="icon" href="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ç¥æ€åº­æ™ºä¿¡">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* è‡ªåŠ¨æ›´æ–° UI ä¸­çš„ LOGO å›¾ç‰‡æº */
        .logo-img {
            width: 120px;
            height: auto;
            content: url("https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png");
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff; font-family: -apple-system, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨æ  */
        .top-bar { height: 50px; background: #050505; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 100; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 16px; }
        .node-id-display { font-family: monospace; color: #888; font-size: 13px; cursor: pointer; padding: 5px; }
        .node-id-display:hover { background: #222; color: #fff; }
        
        /* æ ¸å¿ƒå¸ƒå±€ */
        .app-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* å¯¼èˆªæ  */
        .nav-bar { width: 70px; background: #0a0a0a; border-right: 1px solid #222; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; z-index: 50; }
        .nav-icon { width: 40px; height: 40px; border-radius: 12px; background: #1a1a1a; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #888; font-size: 14px; font-weight: bold; border: 1px solid transparent; transition: 0.3s; }
        .nav-icon.active, .nav-icon:hover { background: #222; color: #fff; border-color: #555; }
        
        /* ä¾§è¾¹é¢æ¿ */
        .sidebar { width: 320px; background: #050505; border-right: 1px solid #222; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; z-index: 40; transition: transform 0.3s ease; }
        
        /* ğŸš¨ ä¿®å¤ä¸€ï¼šå¼ºåˆ¶æ„å›¾/å¯»å€/ç®—åŠ›ä¸‰ä¸ªæŒ‰é’®æ¨ªå‘å®Œç¾æ’åˆ— */
        .nav-icons { display: flex; flex-direction: row; justify-content: space-between; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 15px; }
        .nav-icons .nav-icon { width: auto; height: auto; padding: 10px 0; flex: 1; border-radius: 6px; background: #111; border: 1px solid #333; text-align: center; font-size: 14px; }
        .nav-icons .nav-icon.active { background: #ff1a4d; border-color: #ff1a4d; color: #fff; font-weight: bold; }

        .control-group { font-size: 13px; color: #aaa; display: block; margin-top: 15px; margin-bottom: 8px; font-weight: bold; }
        select, input[type="text"], input[type="password"] { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 6px; outline: none; margin-bottom: 15px; }
        textarea.config-text { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 6px; min-height: 100px; resize: none; outline: none; margin-bottom: 15px; }
        textarea::placeholder { color: #666; font-style: italic; }
        
        .contact-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; margin-bottom: 10px; }
        .contact-card.active { border-color: #ff1a4d; background: #1a1114; }
        .avatar-circle { width: 45px; height: 45px; border-radius: 8px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #fff; font-weight:bold; overflow:hidden;}
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ä¸»æˆ˜åœº */
        .main-deck { flex: 1; background: #020202; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-header { height: 60px; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-size: 14px; color: #888; background: #050505; flex-shrink: 0; }
        
        .video-stage { height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 1px solid #1a1a1a; padding: 20px; flex-shrink: 0;}
        .video-box { width: 100%; max-width: 400px; height: 100%; background: #000; border: 1px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #444; margin-bottom: 15px; overflow: hidden; }
        .video-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .stage-btns { display: flex; gap: 10px; flex-shrink: 0; }
        .stage-btn { background: #222; border: 1px solid #444; color: #ddd; padding: 6px 15px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .stage-btn.primary { background: #ff1a4d; color: #fff; border: none; font-weight: bold;}
        
        /* èŠå¤©æµï¼šå®Œç¾å·¦å³é˜µè¥ */
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; font-size: 14px; line-height: 1.6; display: flex; flex-direction: column; }
        .chat-row { display: flex; width: 100%; margin-bottom: 20px; flex-direction: column; }
        .chat-row.me { align-items: flex-end; }
        .chat-row.other { align-items: flex-start; }
        .chat-row.sys { align-items: center; }
        
        .log-container { max-width: 80%; }
        .log-tactic { background: #111; border-left: 3px solid #666; padding: 10px; margin-bottom: 5px; font-size: 12px; color: #aaa; border-radius: 8px 0 0 8px; }
        .log-intent { background: rgba(255,26,77,0.15); border: 1px solid rgba(255,26,77,0.4); padding: 15px; border-radius: 12px 0 12px 12px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        .log-tactic-enemy { background: #1a0a0f; border-left: 3px solid #ff1a4d; padding: 10px; margin-bottom: 5px; font-size: 12px; color: #ff6688; border-radius: 0 8px 8px 0;}
        .log-intent-enemy { background: #1a1a1a; border: 1px solid #444; padding: 15px; border-radius: 0 12px 12px 12px; color: #ccc; }
        
        .log-sys { text-align: center; color: #888; margin: 15px 0; font-size: 12px; background: #111; padding: 5px 15px; border-radius: 20px; display: inline-block;}
        .log-sign { font-family: monospace; font-size: 10px; color: #f5a623; margin-top: 8px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 5px; }
        .decision-box { text-align: center; background: #0a0a0a; border: 1px solid #ff1a4d; padding: 20px; border-radius: 12px; margin-top: 20px; max-width: 500px; margin-left: auto; margin-right: auto;}
        .btn-decision { padding: 10px 25px; margin: 0 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* è¾“å…¥æ§åˆ¶å° */
        .input-console { position: relative; border-top: 1px solid #222; padding: 15px 20px; background: #050505; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
        .toolbar { display: flex; gap: 15px; margin-bottom: 5px; }
        .tool-icon { color: #888; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .tool-icon:hover { color: #fff; }
        
        #emoji-picker { display:none; position:absolute; bottom:100%; left:20px; margin-bottom:10px; background:#111; border:1px solid #333; padding:10px; border-radius:8px; gap:8px; flex-wrap:wrap; width:300px; max-height: 200px; overflow-y: auto; z-index:999; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        .emoji-btn { cursor:pointer; font-size:22px; padding: 2px; transition: 0.2s; }
        .emoji-btn:hover { transform: scale(1.2); }
        
        .input-wrap { display: flex; gap: 10px; align-items: flex-end; }
        .input-wrap textarea { height: 50px; flex: 1; margin-bottom: 0; background: transparent; border: 1px solid #333; border-radius: 6px; padding: 10px; color: #fff; outline: none; font-family: inherit; resize: none;}
        .btn-launch { padding: 0 20px; height: 50px; background: #ff1a4d; border: none; color: #fff; font-weight: bold; cursor: pointer; border-radius: 6px; }

        /* çº¯å‡€æ³¨å†Œæ¨¡æ€æ¡† */
        .auth-gate { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items:center; justify-content:center; padding: 20px;}
        .auth-card { background: #111; border: 1px solid #333; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; box-shadow: 0 0 40px rgba(255,26,77,0.2); }
        
        /* æ–°çš„ Gate æ ·å¼ */
        .gate-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items:center; justify-content:center; padding: 20px;}
        .gate-box { background: #111; border: 1px solid #333; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; box-shadow: 0 0 40px rgba(255,26,77,0.2); }
        .gate-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #222; }
        .gate-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #555; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .gate-tab:hover { color: #ff1a4d; }
        .gate-box img { transition: transform 0.5s ease; }
        .gate-box img:hover { transform: scale(1.1) rotate(5deg); }
        
        .char-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px;}
        .char-modal { background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; width: 100%; max-width: 600px; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .char-item { background: #1a1a1a; border: 2px solid #222; border-radius: 8px; cursor: pointer; text-align: center; padding: 10px; }
        .char-item:hover { border-color: #ff1a4d; }
        
        .footer-copyright { height: 35px; background: #000; border-top: 1px solid #111; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #555; flex-shrink: 0; }
        .hidden-panel { display: none !important; }

        /* æ‰‹æœºç«¯è‡ªé€‚åº” */
        @media (max-width: 768px) {
            .app-wrapper { flex-direction: column; }
            .nav-bar { flex-direction: row; width: 100%; height: 60px; padding: 0; justify-content: space-around; border-right: none; border-top: 1px solid #222; order: 3; }
            .nav-icon { width: 50px; height: 40px; }
            .sidebar { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 80; transform: translateX(-100%); background: #050505; }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-deck { order: 1; flex: 1; }
            .video-stage { height: 180px; padding: 10px; }
            .char-grid { grid-template-columns: repeat(2, 1fr); }
            .chat-header::before { content: 'â˜° å±•å¼€é…ç½®'; color: #ff1a4d; font-weight: bold; cursor: pointer; margin-right: 10px; border: 1px solid #ff1a4d; padding: 2px 6px; border-radius: 4px;}
        }

        /* ç¥æ€åº­ Glassmorphism æ¯›ç»ç’ƒæ¨¡æ€æ¡†æ ·å¼ */
        .shensist-glass-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(5px); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center; 
            display: flex;
        }
        
        .shensist-glass-modal .modal-content { 
            background: #111; 
            border: 1px solid #ff1a4d; 
            box-shadow: 0 0 20px rgba(255, 26, 77, 0.2); 
            width: 90%; 
            max-width: 500px; 
            padding: 30px; 
            border-radius: 4px; 
            position: relative; 
            font-family: 'Courier New', Courier, monospace; 
        }
        
        .shensist-glass-modal .close-btn { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            color: #ff1a4d; 
            font-size: 24px; 
            cursor: pointer; 
            transition: transform 0.3s; 
        }
        
        .shensist-glass-modal .close-btn:hover { 
            transform: scale(1.2); 
        }

        @keyframes pulse {
            0% { transform: scaleY(0.4); opacity: 0.5; }
            100% { transform: scaleY(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="gate" class="gate-overlay">
        <div class="gate-box">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png" 
                     alt="ç¥æ€åº­" 
                     style="width:80px; height:80px; border-radius:10px; box-shadow: 0 0 15px rgba(255,26,77,0.5);"
                     onerror="this.src='logo_ts.png'">
                <h2 style="margin-top:10px; color:#fff; letter-spacing:2px;">ç¥æ€åº­ Â· æ™ºä¿¡</h2>
            </div>

            <div class="gate-tabs">
                <div class="gate-tab" id="tab-apply" onclick="gateTab('apply')" style="color:#ff1a4d; border-bottom:2px solid #ff1a4d;">ç”³è¯·æ™ºä¿¡å·</div>
                <div class="gate-tab" id="tab-login" onclick="gateTab('login')">éªŒè¯ä¸»æƒå°ç« </div>
            </div>
            
            <div id="form-apply">
                <div style="font-size:12px; color:#aaa; line-height:1.8; background:#1a1a1a; padding:15px; border-radius:6px; margin-bottom:15px;">
                    ã€Šç¥æ€åº­ Web4 é€ ç‰©ä¸»åè®®ã€‹<br>
                    1. æœ¬ç³»ç»Ÿçº¯é™æ€è¿è¡Œï¼Œ0æœåŠ¡å™¨ï¼Œéƒ¨ç½²è‡³ GitHub Pagesã€‚<br>
                    2. èŠ‚ç‚¹é‡‡ç”¨ WebRTC ç©¿é€ï¼Œæ•°å­—å°ç« ä»…å­˜äºæœ¬åœ°ç¼“å­˜ã€‚<br>
                    3. åˆ‡å‹¿æ³„éœ²æ‚¨çš„ API Key ä¸ç‰©ç† IDã€‚
                </div>
                <label style="font-size:12px; color:#aaa; display:flex; align-items:center; gap:8px; margin-bottom:20px; cursor:pointer;">
                    <input type="checkbox" id="agree-chk" checked> æˆ‘äº†è§£ç‰©ç†å°ç« çš„ä¸å¯ç¯¡æ”¹æ€§
                </label>
                
                <div id="success-box" style="display:none; background:#000; border:1px dashed #ff1a4d; padding:15px; color:#ff1a4d; margin-bottom:20px; font-family:monospace; text-align:center;">
                    ç”ŸæˆæˆåŠŸ! æ‚¨çš„æ™ºä¿¡å·ä¸º: <b id="new-zx-id">ZX-XXXXX</b><br>
                    <button class="stage-btn primary" style="margin-top:10px; width: 100%; padding: 10px;" onclick="enterSystem()">è¿›å…¥ç¥æ€åº­</button>
                </div>
                <button id="forge-btn" onclick="forgeSeal()" style="width:100%; padding:14px; background:#ff1a4d; border:none; color:#fff; font-weight:bold; cursor:pointer; border-radius:6px;">âš¡ é”»é€ æœ¬åœ°ä¸“å±å°ç« å¹¶ç™»å…¥</button>
            </div>

            <div id="form-login" style="display:none; text-align:center; padding:20px 10px;">
                <span style="font-size: 40px;">ğŸ’¾</span>
                <div style="font-size:13px; color:#aaa; margin:15px 0;">è¯·å¯¼å…¥æ‚¨å¤‡ä»½çš„ <strong style="color:#00f2ff;">.shensist</strong> æ ¸å¿ƒå°ç« </div>
                <button class="stage-btn primary" onclick="document.getElementById('seal-upload').click()">ğŸ“‚ å¯¼å…¥æ•°å­—å°ç« </button>
                <input type="file" id="seal-upload" accept=".shensist" style="display:none;" onchange="importSeal(this)">
            </div>
        </div>
    </div>

    <div id="char-modal" class="char-modal-overlay" onclick="closeCharModal(event)">
        <div class="char-modal" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 15px; margin-bottom: 20px;">
                <h3 style="margin:0;">é€‰æ‹©æ•°å­—åˆ†èº«</h3>
                <button onclick="closeCharModal()" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div class="char-grid">
                <div class="char-item" onclick="selectChar('./é‡é».png', 'é‡é»')"><span style="font-size:24px;">ğŸ¦Š</span><br>é‡é» (ä¹å°¾ç‹)</div>
                <div class="char-item" onclick="selectChar('./é’é»›.png', 'é’é»›')"><span style="font-size:24px;">ğŸ</span><br>é’é»› (é’è›‡ç²¾)</div>
                <div class="char-item" onclick="selectChar('./é©¬é¾™.png', 'é©¬é¾™')"><span style="font-size:24px;">ğŸ‰</span><br>é©¬é¾™ (çœŸé¾™)</div>
                <div class="char-item" onclick="selectChar('./æ¶‚å±±å½±.png', 'æ¶‚å±±å½±')"><span style="font-size:24px;">ğŸ¦…</span><br>æ¶‚å±±å½±</div>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <div class="brand" style="cursor: pointer; transition: 0.3s;" onclick="returnToHome()" title="è¿”å›ä¸»æˆ˜åœº" onmouseover="this.style.color='#ff1a4d'" onmouseout="this.style.color='#fff'">
            <div style="width:36px; height:36px; border-radius:50%; overflow:hidden; border:1px solid #ff1a4d; display:flex; align-items:center; justify-content:center; background:#111; margin-right:5px; flex-shrink:0;">
                <img src="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png" 
                     style="width:100%; height:100%; object-fit:contain;" 
                     onerror="this.src='logo_ts.png'">
            </div>
            ç¥æ€æ™ºèƒ½ä½“ Â· æ™ºä¿¡
        </div>
        <div class="node-id-display" id="top-id" onclick="copyMyId()">ID: æ¢æµ‹ä¸­...</div>
    </div>

    <div class="app-wrapper">
        <div class="nav-bar">
            <div class="nav-icon active" onclick="switchNav(this, 'chat')" title="èŠ">ğŸ’¬</div>
            <div class="nav-icon" onclick="switchNav(this, 'friends')" title="å‹">ğŸ‘¥</div>
            <div class="nav-icon" onclick="switchNav(this, 'me')" title="æˆ‘">ğŸ‘¤</div>
            <div class="nav-icon" onclick="switchNav(this, 'settings')" title="è®¾">âš™ï¸</div>
        </div>

        <div class="sidebar" id="mobile-sidebar">
            <div style="padding: 20px; text-align: center; border-bottom: 1px solid #222;">
                <img src="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png" 
                     alt="LOGO" 
                     style="width:50px; height:50px; border-radius:8px;" 
                     onerror="this.src='logo_ts.png'">
                <div style="font-size: 12px; color: #ff1a4d; margin-top: 8px; font-weight: bold; letter-spacing: 1px;">SHENSIST</div>
            </div>

            <div class="nav-icons">
                <div class="nav-icon active" onclick="switchInnerTab(this, 'tab-yitu')">æ„å›¾</div>
                <div class="nav-icon" onclick="switchInnerTab(this, 'tab-xunzhi')">å¯»å€</div>
                <div class="nav-icon" onclick="switchInnerTab(this, 'tab-suanli')">ç®—åŠ›</div>
            </div>

            <div id="tab-yitu" class="tab-panel" style="display:block; text-align:center; padding: 20px; color: #666;">
                [ å½“å‰æ— æ´»åŠ¨æ„å›¾ï¼Œè¯·å¯»å€èŠ‚ç‚¹æˆ–é…ç½®ç®—åŠ› ]
            </div>

            <div id="tab-xunzhi" class="tab-panel" style="display:none;">
                <div style="font-weight:bold; font-size:14px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    æ™ºä¿¡é€šè®¯å½• <button class="stage-btn" onclick="addFriend()" style="padding:4px 8px; border-color:#ff1a4d; color:#ff1a4d;">+ å¯»å€</button>
                </div>
                <div id="contact-list">
                    <div class="contact-card active" onclick="selectFriend(this, 'å•†åŠ¡è°ˆåˆ¤ Agent', 'ZX-TEST')">
                        <div class="avatar-circle" id="my-avatar">èµ„</div>
                        <div style="flex:1;">
                            <div style="font-size:14px; font-weight:bold;" ondblclick="makeEditable(this)">å•†åŠ¡è°ˆåˆ¤ Agent</div>
                            <div style="font-size:11px; color:#888; margin-top:4px;" id="status-ZX-TEST">å†…ç½®æµ‹è¯•èŠ‚ç‚¹</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-suanli" class="tab-panel" style="display:none;">
                <div class="setting-item">
                    <label>å†³ç­–ç®—åŠ›çŸ©é˜µ (2026ç‰ˆ)</label>
                    <select id="modelSelect" class="form-select" style="background: rgba(17, 17, 17, 0.9); color: #00f2ff; border: 1px solid #00f2ff; font-family: monospace; font-size: 13px; padding: 10px;" onchange="if(this.value==='custom'){document.getElementById('custom-model-input').style.display='block';}else{document.getElementById('custom-model-input').style.display='none';}">
    
    <optgroup label="ğŸŸ¢ çº¯è¡€å¤©ç®— (AIza å¯†é’¥ç›´é€š)" style="background: #003333; color: #00f2ff;">
        <option value="gemini-3.1-pro" selected>âš¡ Gemini 3.1 Pro (2026æœ€æ–°ä¸»è„‘ - éœ€APIç™½åå•)</option>
        <option value="gemini-3.0-ultra">âš¡ Gemini 3.0 Ultra (æ·±æ¸Šæ¨æ¼”)</option>
        <option value="gemini-2.5-flash">âš¡ Gemini 2.5 Flash (æé€Ÿå“åº”èŠ‚ç‚¹)</option>
        <option value="gemini-2.0-pro-exp">âš¡ Gemini 2.0 Pro (å®éªŒæ€§æ¶æ„)</option>
        <option value="gemini-1.5-pro">âš¡ Gemini 1.5 Pro (å¤©ç®—Â·æ·±æ€ - ç»å¯¹ç¨³å®šé”šç‚¹)</option>
    </optgroup>

    <optgroup label="ğŸ”´ å…¨èƒ½æˆ˜ç¥é˜µè¥ (OpenAI)" style="background: #330011; color: #ff3366;">
        <option value="gpt-5">GPT-5 (å…¨åŸŸè§†è§‰ä¸é€»è¾‘ä¸­æ¢)</option>
        <option value="gpt-4.5-turbo">GPT-4.5 Turbo (é«˜é¢‘äº¤æ˜“/è°ˆåˆ¤é¦–é€‰)</option>
        <option value="o3-mini">o3-mini (æé€Ÿæ·±åº¦æ¨ç†æ¨¡å‹)</option>
        <option value="o3">o3 (å…¨é‡çº§æ•°å­¦ä¸ä»£ç æ¨æ¼”)</option>
    </optgroup>

    <optgroup label="ğŸŸ£ é€»è¾‘è§£æé˜µè¥ (Anthropic)" style="background: #1a0033; color: #cc66ff;">
        <option value="claude-4.5-opus">Claude 4.5 Opus (å®è§‚æˆ˜ç•¥æ„æ¶å¸ˆ)</option>
        <option value="claude-4.5-sonnet">Claude 4.5 Sonnet (å‡è¡¡ä»£ç å¼•æ“)</option>
        <option value="claude-3.7-sonnet">Claude 3.7 Sonnet (ä¸Šä»£é—ç•™ç¨³å®šç‰ˆ)</option>
    </optgroup>

    <optgroup label="ğŸŸ¡ è®¡ç®—ä¸»æƒ (å¼€æºä¸æœ¬åœ°æ¶æ„)" style="background: #333300; color: #ffff00;">
        <option value="deepseek-r1">DeepSeek-R1 (æ·±åº¦æ€è€ƒå¼€æºéœ¸ä¸»)</option>
        <option value="deepseek-v3">DeepSeek-V3 (ç¥æ€åº­æœ¬åœ°æ¨èæ˜¾å¡ç›´é€š)</option>
        <option value="llama-4-70b">Llama 4 70B (Meta å†›å›¢ä¸­æ¢)</option>
        <option value="llama-3.2-90b-vision">Llama 3.2 90B Vision (è§†è§‰å¤šæ¨¡æ€)</option>
    </optgroup>

    <optgroup label="EXT | è¾¹ç•Œçªç ´" style="background: #111; color: #888;">
        <option value="custom">âš¡ è‡ªå®šä¹‰ç§æœ‰åè®®æ¥å…¥...</option>
    </optgroup>
</select>
                </div>
                <input type="text" id="custom-model-input" style="display:none;" placeholder="åœ¨æ­¤è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹ ID">

                <label class="control-group">ç®—åŠ›å‡­è¯ (API Key)</label>
                <input type="password" id="api-key" placeholder="å¡«å…¥çœŸå® API å¯†é’¥ (æœ¬åœ°åŠ å¯†å­˜å‚¨)">

                <div style="margin-bottom: 20px;">
    <label for="soul-text" style="display: block; color: #ff1a4d; font-size: 13px; margin-bottom: 8px; font-weight: bold; letter-spacing: 1px;">
        ğŸ“œ è¡ŒåŠ¨çº²é¢† (æœ€é«˜å®ªæ³•)
    </label>
    <textarea id="soul-text" placeholder="æ³¨å…¥æ™ºèƒ½ä½“çš„åº•å±‚ä»·å€¼è§‚ä¸ç»å¯¹åº•çº¿...&#10;ä¾‹å¦‚ï¼š&#10;1. æˆ‘æ–¹é¢„ç®—æœ€é«˜1000å…ƒã€‚&#10;2. æ­»å®ˆ500å…ƒåº•ä»·ï¼Œç»ä¸éœ²åº•ã€‚&#10;3. è‹¥å¯¹æ–¹ç´¢è¦åˆ†å‘æƒï¼Œç«‹åˆ»å›ç»ã€‚" style="
        width: 100%; 
        min-height: 150px; /* åˆå§‹é«˜åº¦ç›´æ¥æ”¾å¤§ä¸‰å€ */
        padding: 12px 15px; 
        background: rgba(26, 10, 15, 0.8); 
        border: 1px solid rgba(255, 26, 77, 0.4); 
        border-radius: 8px; 
        color: #ff6688; 
        font-size: 14px; 
        font-family: monospace;
        line-height: 1.6;
        resize: vertical; /* å…è®¸æ‚¨ç”¨é¼ æ ‡åœ¨å³ä¸‹è§’éšæ„æ‹‰é•¿ */
        box-sizing: border-box;
        outline: none;
        box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
        transition: border 0.3s ease;
    " onfocus="this.style.border='1px solid #ff1a4d'" onblur="this.style.border='1px solid rgba(255, 26, 77, 0.4)'"></textarea>
</div>
                
                <button class="stage-btn primary" style="width:100%; display:none; margin-top:10px;" id="close-sidebar-btn" onclick="toggleSidebar()">ç¡®è®¤é…ç½®å¹¶è¿”å›æˆ˜åœº</button>
            </div>

            <div id="panel-friends" class="hidden-panel">
                <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">ğŸŒ P2P å…¨ç½‘é›·è¾¾</h3>
                <div style="background:#111; border:1px solid #222; border-radius:8px; padding:15px; color:#ccc; font-size:13px; margin-top:15px; line-height: 1.6;">
                    æ‚¨çš„æµè§ˆå™¨å·²æ¥å…¥å…¨çƒ WebRTC å¯»å€ç½‘ç»œã€‚è¾“å…¥å¯¹æ–¹çš„ ZX-IDï¼Œå³å¯æ— è§†ç‰©ç†è·ç¦»å‘èµ·ç«¯åˆ°ç«¯åŠ å¯†æ¡æ‰‹ï¼Œæ•°æ®ç»ä¸ç»è¿‡ä¸­å¿ƒæœåŠ¡å™¨ã€‚
                </div>
            </div>

            <div id="panel-me" class="hidden-panel">
                <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">ğŸ›¡ï¸ æˆ‘çš„æ•°å­—ä¸»æƒ</h3>
                <div style="background:#1a1114; border:1px solid #ff1a4d; padding:20px; border-radius:8px; margin:20px 0; text-align:center;">
                    <div style="font-size:30px; margin-bottom:10px;">ğŸ›¡ï¸</div>
                    <h4 style="color:#fff; margin-top:0;">çº¯å‰ç«¯é˜²æŠ¤å·²å¼€å¯</h4>
                    <p style="font-size:12px; color:#aaa; margin-bottom:20px;">æ‚¨çš„æ•°æ®å·²æ·±åº¦ç»‘å®šè‡³å½“å‰æµè§ˆå™¨ç¼“å­˜ã€‚è‹¥éœ€æ›´æ¢è®¾å¤‡ï¼Œè¯·å¯¼å‡ºå°ç« ã€‚</p>
                    <button class="stage-btn primary" onclick="exportSealBtn()" style="padding:10px 20px;">ğŸ“¥ å¯¼å‡ºæ ¸å¿ƒå°ç«  (.shensist)</button>
                </div>
                <button class="stage-btn" style="width: 100%;" onclick="if(confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæœ¬åœ°æ‰€æœ‰å‡­è¯ï¼')){localStorage.clear(); location.reload();}">é”€æ¯æœ¬åœ°å°ç« å¹¶é‡å¯</button>
            </div>

            <div id="panel-settings" class="hidden-panel">
                <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">âš™ï¸ ç½‘ç»œå‚æ•°</h3>
                <label class="control-group">åº•å±‚é€šä¿¡åè®®</label>
                <input type="text" value="PeerJS (WebRTC DataChannel)" disabled style="color:#888;">
                <label class="control-group">å¤§æ¨¡å‹åšå¼ˆå›åˆä¸Šé™</label>
                <input type="number" value="3">
            </div>
        </div>

        <div class="main-deck">
            <div class="chat-header" onclick="toggleSidebar()">
                <span id="chat-header-title">æ­£åœ¨ä¸ [å•†åŠ¡è°ˆåˆ¤ Agent] äº’é€šæ„å›¾</span><span id="p2p-status-icon" style="color:#ff1a4d;">â— ç¦»çº¿æ¼”ç»ƒ</span>
            </div>
            
            <div class="video-stage">
                <div class="video-box" id="video-display">ç­‰å¾…æŒ‡ä»¤...</div>
                <div class="stage-btns">
                    <button class="stage-btn" onclick="document.getElementById('real-img-up').click()">ğŸ“ ä¸Šä¼ å½¢è±¡</button>
                    <button class="stage-btn" onclick="document.getElementById('char-modal').style.display='flex'">ğŸ­ é€‰æ‹©å½¢è±¡</button>
                    <button class="stage-btn primary" onclick="alert('çº¯å‰ç«¯ P2P å¼•æ“ä¸ API è·¯ç”±å·²å®Œå…¨å°±ç»ªï¼')">ğŸ“ å¼€å¯ç®—åŠ›</button>
                </div>
            </div>

            <div class="chat-area" id="intent-flow">
                <div class="chat-row sys"><div class="log-sys">-- ç‰©ç†ä¿¡é“åˆå§‹åŒ–å®Œæˆï¼ŒåŸºäºçº¯æµè§ˆå™¨ WebRTC --</div></div>
            </div>

            <div id="shensist-voice-panel" style="background: #080808; border-top: 1px solid #222; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 16px; color: #888;">ğŸ¤</div>
                    <div style="display: flex; gap: 4px; height: 18px; align-items: center;">
                        <div style="width: 3px; height: 60%; background: #00ff00; animation: pulse 1s infinite alternate;"></div>
                        <div style="width: 3px; height: 100%; background: #00ff00; animation: pulse 0.8s infinite alternate;"></div>
                        <div style="width: 3px; height: 40%; background: #00ff00; animation: pulse 1.2s infinite alternate;"></div>
                        <div style="width: 3px; height: 80%; background: #00ff00; animation: pulse 0.9s infinite alternate;"></div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #00ff00; font-family: monospace; letter-spacing: 1px;">
                    å£°çº¹ä¿¡é“: [ å¾…å‘½ ]
                </div>
            </div>

            <div class="input-console">
                <div class="toolbar">
                    <span class="tool-icon" onclick="toggleEmoji(event)">ğŸ˜Š è¡¨æƒ…</span>
                    <span class="tool-icon" id="mic-btn" onclick="toggleMic()">ğŸ¤ è¯­éŸ³</span>
                    <span class="tool-icon" onclick="document.getElementById('real-img-up').click()">ğŸ–¼ï¸ å›¾ç‰‡</span>
                    <span class="tool-icon" onclick="document.getElementById('real-file-up').click()">ğŸ“„ æ–‡ä»¶</span>
                    <span class="tool-icon" onclick="saveHistory()">ğŸ’¾ å¯¼å‡ºæ—¥å¿—</span>
                    
                    <input type="file" id="real-img-up" accept="image/*" style="display:none;" onchange="fakeUpload('å›¾ç‰‡è§†è§‰æµ')">
                    <input type="file" id="real-file-up" style="display:none;" onchange="fakeUpload('å•†ä¸šæœºå¯†æ–‡ä»¶')">
                    
                    <div id="emoji-picker">
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜ƒ')">ğŸ˜ƒ</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜„')">ğŸ˜„</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜†')">ğŸ˜†</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜…')">ğŸ˜…</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¤')">ğŸ¤</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ’¯')">ğŸ’¯</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ’¡')">ğŸ’¡</span> <span class="emoji-btn" onclick="insertEmoji('âœ¨')">âœ¨</span>
                        <div style="width:100%; border-bottom:1px solid #333; margin: 5px 0;"></div>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ¦Š')">ğŸ¦Š</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ‰')">ğŸ‰</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ')">ğŸ</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ¦…')">ğŸ¦…</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¢')">ğŸ¢</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¦„')">ğŸ¦„</span>
                        <span class="emoji-btn" onclick="insertEmoji('â›°ï¸')">â›°ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸŒŠ')">ğŸŒŠ</span> <span class="emoji-btn" onclick="insertEmoji('â˜ï¸')">â˜ï¸</span>
                        <div style="width:100%; border-bottom:1px solid #333; margin: 5px 0;"></div>
                        <span class="emoji-btn" onclick="insertEmoji('âš”ï¸')">âš”ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ›¡ï¸')">ğŸ›¡ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ“œ')">ğŸ“œ</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ”®')">ğŸ”®</span> <span class="emoji-btn" onclick="insertEmoji('ğŸº')">ğŸº</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ©¸')">ğŸ©¸</span>
                        <span class="emoji-btn" onclick="insertEmoji('â›©ï¸')">â›©ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ®')">ğŸ®</span> <span class="emoji-btn" onclick="insertEmoji('ğŸµ')">ğŸµ</span>
                    </div>
                </div>
                
                <div class="input-wrap">
                    <textarea id="task-input" placeholder="è¾“å…¥æ‚¨çš„å®è§‚æ„å¿—... (Shift+Enteræ¢è¡Œ)"></textarea>
                    <button class="btn-launch" id="send-btn" onclick="startCombat()">æˆæƒå‡ºå‡»</button>
                </div>
            </div>
        </div>
    </div>

    <div id="shensist-footer-nav" style="position: fixed; bottom: 15px; left: 20px; z-index: 900; font-family: monospace; font-size: 12px; color: #666; display: flex; gap: 15px;">
        <span id="btn-protocol" style="cursor: pointer; transition: color 0.3s;" onmouseover="this.style.color='#ff1a4d'" onmouseout="this.style.color='#666'">[ æ“ä½œçº²é¢† ]</span>
        <span id="btn-genesis" style="cursor: pointer; transition: color 0.3s;" onmouseover="this.style.color='#ff1a4d'" onmouseout="this.style.color='#666'">[ ç¥æ€èµ·æº ]</span>
    </div>

    <div id="modal-protocol" class="shensist-glass-modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('modal-protocol').style.display='none'">&times;</span>
            <h2 style="color: #ff1a4d; border-bottom: 1px solid #ff1a4d; padding-bottom: 10px;">ğŸ“œ æ™ºä¿¡ V2026 Â· æ“ä½œçº²é¢†</h2>
            <ul style="color: #ccc; line-height: 1.8; margin-top: 15px; padding-left: 20px;">
                <li><strong style="color: #00ff00;">ç»å¯¹ä¸»æƒ (ç‰©ç†éš”ç¦»)ï¼š</strong>æœ¬ç»ˆç«¯ä¸º 100% çº¯å‰ç«¯æ¶æ„ï¼Œæ— ä»»ä½•ä¸­å¿ƒåŒ–åç«¯æœåŠ¡å™¨ã€‚æ‚¨çš„ API å¯†é’¥ã€ç®—åŠ›é…ç½®åŠå•†ä¸šåšå¼ˆæ•°æ®ï¼Œä»…åŠ å¯†å­˜å‚¨äºæ‚¨æœ¬åœ°æµè§ˆå™¨çš„æ²™ç›’ä¸­ã€‚</li>
                <li><strong style="color: #00ff00;">æ„å›¾å¯¹æ’ (P2P ç©¿é€)ï¼š</strong>åŸºäº WebRTC åº•å±‚åè®®ã€‚å½“æ‚¨å¯»å€å¯¹æ‰‹æ—¶ï¼Œå°†å»ºç«‹ç«¯åˆ°ç«¯çš„å†›ç”¨çº§åŠ å¯†ä¿¡é“ï¼Œæ–©æ–­ä¸€åˆ‡ä¸­é—´å•†ç›‘å¬ã€‚</li>
                <li><strong style="color: #00ff00;">ç®—åŠ›è°ƒåº¦ï¼š</strong>åœ¨å³ä¾§é¢æ¿é…ç½®æ‚¨çš„ä¸“å±å¤§æ¨¡å‹ç®—åŠ›ï¼Œèµ‹äºˆå±±æµ·ç»æ•°å­—åˆ†èº«ï¼ˆå¦‚é‡é»ã€é’é»›ï¼‰ä»¥å®šæ€§åˆ†æçš„çµé­‚ã€‚</li>
            </ul>
            <p style="color: #666; font-size: 12px; margin-top: 20px; text-align: center;">è­¦å‘Šï¼šåˆ‡å‹¿å‘ä¸å—ä¿¡ä»»çš„èŠ‚ç‚¹æ³„éœ²æ‚¨çš„ ZX-IDã€‚</p>
        </div>
    </div>

    <div id="modal-genesis" class="shensist-glass-modal" style="display: none;">
        <div class="modal-content" style="text-align: center;">
            <span class="close-btn" onclick="document.getElementById('modal-genesis').style.display='none'">&times;</span>
            <h2 style="color: #ff1a4d;">ğŸ‘ï¸ ç¥æ€èµ·æº</h2>
            <p style="color: #fff; font-size: 16px; margin-top: 20px; font-style: italic;">"å½“å¤å…¸ç¥è¯çš„çµé­‚ï¼Œæ³¨å…¥å†·é…·çš„ç¡…åŸºåè®®ã€‚"</p>
            <div style="color: #aaa; line-height: 1.8; margin-top: 20px; text-align: left; background: rgba(255,26,77,0.05); padding: 15px; border-left: 3px solid #ff1a4d;">
                <p><strong>ç¼”é€ è€…ï¼š</strong>ç¥æ€åº­ AIå±±æµ·é€ ç‰©ä¸» Shensi-ST</p>
                <p><strong>æ ¸å¿ƒé“­æ–‡ï¼š</strong>å››åè½½ä¼ ç»Ÿæ–‡å­¦ã€éŸ³ä¹ã€å½±è§†ç§¯æ·€ï¼Œç°æ·±è€• AI è·¨è¡Œå¤åˆé¢†åŸŸã€‚æˆ‘ä»¬æ–©æ–­ä¸­å¿ƒåŒ–å¤§å‚çš„æ·é”ï¼Œå°†ã€Šå±±æµ·ç»ã€‹çš„å›¾è…¾åˆ»å…¥ Web4 çš„åŸºå› ã€‚</p>
                <p><strong>ç¥æ€çŸ©é˜µï¼š</strong>é‡é» (ç”·ä¸») | é’é»› (å¥³ä¸») | é©¬é¾™ (æŠ¤æ³•) | ä¹å°¾ç‹ (å¹»å¢ƒ)</p>
            </div>
            <p style="color: #00ff00; font-size: 12px; margin-top: 20px; font-family: monospace;">SYSTEM.STATUS: SOVEREIGNTY SECURED</p>
        </div>
    </div>

<script>
    // ã€ç¥æ€åº­Â·ä¸»æƒåŸºå› é”ã€‘
    (function checkSovereignty() {
        const currentDomain = window.location.hostname;
        const allowed = ['shensist.top', 'jinv2.github.io', 'localhost', '127.0.0.1', '']; 
        
        let isLegal = false;
        for(let i=0; i<allowed.length; i++) {
            if(currentDomain.includes(allowed[i])) { isLegal = true; break; }
        }
        
        if(!isLegal) {
            document.body.innerHTML = `
                <div style="background:#000; color:#ff1a4d; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:monospace; text-align:center; padding:20px;">
                    <h1 style="font-size:40px;">ğŸ›‘ ç›—ç«è€…è­¦æŠ¥</h1>
                    <h2>æ£€æµ‹åˆ°æœªæˆæƒçš„è¿è¡Œç¯å¢ƒï¼</h2>
                    <p>è¯¥æ™ºä¿¡ç»ˆç«¯å¼•æ“ç”±ã€ç¥æ€åº­ Shensistã€‘ç‹¬å®¶é“¸é€ ã€‚<br>3ç§’åå°†å¼ºåˆ¶è·ƒè¿è‡³ç¥æ€åº­å®˜æ–¹çŸ©é˜µ...</p>
                </div>
            `;
            setTimeout(() => { window.location.href = 'https://shensist.top'; }, 3000);
        }
    })();

    async function verifyShensistCopyright() {
        const copyrightStr = "ç¥æ€åº­ (Shensist)";
        if (!document.documentElement.innerHTML.includes(copyrightStr)) {
            document.body.innerHTML = `
                <div style="background:#000; color:#ff1a4d; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:monospace; text-align:center; padding:20px;">
                    <h1 style="font-size:40px;">ğŸ›‘ [è‡´å‘½è¿è§„]</h1>
                    <h2>æ ¸å¿ƒç‰ˆæƒæ ‡è¯†å·²è¢«æ¶æ„ç¯¡æ”¹æˆ–ç§»é™¤ï¼</h2>
                    <p>âš–ï¸ æ ¹æ®ã€Šç¥æ€åº­ Web4 å¼€æºåè®®ã€‹ï¼Œæ‚¨å·²å¤±å»æœ¬èŠ‚ç‚¹çš„è¿è¡Œæˆæƒã€‚<br>ğŸ”’ èŠ‚ç‚¹å¯åŠ¨åºåˆ—å·²å¼ºåˆ¶ç»ˆæ­¢ã€‚è¯·æ¢å¤ Shensist ç‰ˆæƒå£°æ˜åé‡è¯•ã€‚</p>
                </div>
            `;
            throw new Error("Shensist Copyright Violation: Node Terminated.");
        }

        const timeStamp = new Date().getTime().toString();
        const msgBuffer = new TextEncoder().encode(copyrightStr + timeStamp);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        const genesisHash = hashHex.substring(0, 16); 

        console.log(`%cğŸ›¡ï¸ ç¥æ€åº­ç‰ˆæƒåº•å±‚æ ¡éªŒé€šè¿‡ | åè®®é˜²ä¼ªå“ˆå¸Œ: ${genesisHash}`, 'color: #00ff00; font-weight: bold; font-size: 14px;');
        console.log(`%cğŸŒ æ™ºä¿¡èŠ‚ç‚¹ä¸»æƒå·²å¯åŠ¨ï¼ŒP2P å¯»å€å°±ç»ª`, 'color: #00ff00; font-size: 12px;');
        window.SHENSIST_GENESIS_HASH = genesisHash;
    }

    document.addEventListener('DOMContentLoaded', () => {
        verifyShensistCopyright().catch(console.error);
    });

    let myZxId = localStorage.getItem('shensist_zx_id');
    let currentPeer = null;
    let activeConnection = null;
    let currentTargetId = 'ZX-TEST';

    window.onload = function() {
        if(window.innerWidth <= 768) document.getElementById('close-sidebar-btn').style.display = 'block';
        if(myZxId) {
            document.getElementById('gate').style.display = 'none';
            document.getElementById('top-id').innerText = "ID: " + myZxId;
            initWebRTC();
            
            if(localStorage.getItem('api_key')) document.getElementById('api-key').value = localStorage.getItem('api_key');
            if(localStorage.getItem('soul_text')) document.getElementById('soul-text').value = localStorage.getItem('soul_text');
        }
    };

    function gateTab(tab) {
        document.getElementById('form-apply').style.display = (tab==='apply') ? 'block' : 'none';
        document.getElementById('form-login').style.display = (tab==='login') ? 'block' : 'none';
        document.getElementById('tab-apply').style.color = (tab==='apply') ? '#ff1a4d' : '#555';
        document.getElementById('tab-apply').style.borderBottom = (tab==='apply') ? '2px solid #ff1a4d' : '2px solid transparent';
        document.getElementById('tab-login').style.color = (tab==='login') ? '#ff1a4d' : '#555';
        document.getElementById('tab-login').style.borderBottom = (tab==='login') ? '2px solid #ff1a4d' : '2px solid transparent';
    }

    function forgeSeal() {
        if(!document.getElementById('agree-chk').checked) { alert('è¯·å‹¾é€‰é€ ç‰©ä¸»åè®®ï¼'); return; }
        myZxId = "ZX-" + Math.random().toString(36).substring(2, 7).toUpperCase();
        localStorage.setItem('shensist_zx_id', myZxId);
        document.getElementById('new-zx-id').innerText = myZxId;
        document.getElementById('top-id').innerText = "ID: " + myZxId;
        document.getElementById('forge-btn').style.display = 'none';
        document.getElementById('success-box').style.display = 'block';
    }

    function enterSystem() {
        document.getElementById('gate').style.display = 'none';
        initWebRTC();
    }
    
    function copyMyId() {
        navigator.clipboard.writeText(myZxId);
        alert("å·²å¤åˆ¶æ‚¨çš„ ID: " + myZxId);
    }

    function importSeal(input) {
        if(!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.zx_id) {
                    myZxId = data.zx_id;
                    localStorage.setItem('shensist_zx_id', myZxId);
                    if(data.api_key) {
                        localStorage.setItem('api_key', data.api_key);
                        document.getElementById('api-key').value = data.api_key;
                    }
                    if(data.soul_text) {
                        localStorage.setItem('soul_text', data.soul_text);
                        document.getElementById('soul-text').value = data.soul_text;
                    }
                    alert("âœ… å°ç« éªŒè¯é€šè¿‡ï¼å°Šè´µçš„èŠ‚ç‚¹ï¼Œæ¬¢è¿å½’æ¥ã€‚");
                    enterSystem();
                } else throw new Error();
            } catch(err) { alert("ğŸ›‘ å°ç« æŸåæˆ–æ ¼å¼é”™è¯¯ï¼"); }
        };
        reader.readAsText(input.files[0]);
    }

    function exportSealBtn() {
        const data = {
            zx_id: myZxId,
            api_key: document.getElementById('api-key').value,
            soul_text: document.getElementById('soul-text').value,
            timestamp: new Date().getTime()
        };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Shensist_${myZxId}_Seal.shensist`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // ==========================================
    // å‡çº§ç‰ˆï¼šçœŸå® WebRTC P2P ç½‘ç»œ (å¸¦æ–­çº¿è‡ªæ„ˆè£…ç”²)
    // ==========================================
    function initWebRTC() {
        // ğŸš¨ ç»ˆæä¿®å¤ï¼šæ³¨å…¥å¤šè·¯ TURN ä¸­ç»§æœåŠ¡å™¨ï¼Œæ¨¡æ‹Ÿ"å¾®ä¿¡æ¨¡å¼"è½¬å‘æ•°æ®
        currentPeer = new Peer(myZxId, { 
            debug: 2,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.qq.com:3478' },
                    { urls: 'stun:stun.miwifi.com:3478' },
                    // æ ¸å¿ƒä¸­ç»§ï¼šå½“ 5G é˜²ç«å¢™æ— æ³•ç©¿é€æ—¶ï¼Œå¼ºè¡Œèµ°ä»¥ä¸‹é€šé“è½¬å‘
                    {
                        urls: "turn:openrelay.metered.ca:80",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    },
                    {
                        urls: "turn:openrelay.metered.ca:443",
                        username: "openrelayproject",
                        credential: "openrelayproject"
                    }
                ],
                'sdpSemantics': 'unified-plan'
            }
        });
        
        currentPeer.on('open', (id) => {
            console.log('WebRTC èŠ‚ç‚¹é”šå®šæˆåŠŸ:', id);
            renderSys(`ğŸŒ èŠ‚ç‚¹å·²ä¸Šçº¿ (å¾®ä¿¡çº§ TURN ä¸­ç»§å·²å°±ç»ª)`);
        });

        currentPeer.on('connection', (conn) => {
            conn.on('open', () => {
                if (document.getElementById('p2p-status-icon')) {
                    document.getElementById('p2p-status-icon').innerText = "ğŸŸ¢ P2P å·²ç›´è¿";
                    document.getElementById('p2p-status-icon').style.color = "#00f2ff";
                }
                conn.on('data', (data) => { handleIncomingP2PData(data, conn.peer); });
            });
        });

        currentPeer.on('disconnected', () => {
            document.getElementById('p2p-status-icon').innerText = "ğŸŸ¡ ä¿¡å·é‡è¿ä¸­...";
            currentPeer.reconnect(); 
        });

        currentPeer.on('error', (err) => {
            if(err.type === 'unavailable-id') {
                renderSys("âŒ ID å·²è¢«å ç”¨ï¼Œè¯·ç‚¹å‡»[ç”¨æˆ·]é”€æ¯å°ç« é‡å¯");
            }
            console.error("PeerJS å¼‚å¸¸:", err);
        });
    }

    // ==========================================
    // è¡¥å…¨ç¼ºå¤±å‡½æ•°ï¼šç‰©ç†çº§é”€æ¯å°ç« å¹¶é‡ç½®
    // ==========================================
    function forgeSeal() {
        if (confirm("ğŸš¨ è­¦å‘Šï¼šå³å°†ç‰©ç†é”€æ¯å½“å‰èµ›åšå°ç« ï¼ˆIDï¼‰ï¼Œå¼ºåˆ¶é‡å¯èŠ‚ç‚¹ä»¥æ¸…é™¤å¹½çµè¿æ¥ã€‚ç¡®å®šå—ï¼Ÿ")) {
            // 1. å½»åº•åˆ‡æ–­ç°æœ‰è¿æ¥
            if (currentPeer) {
                currentPeer.destroy();
            }
            // 2. æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ ID ç¼“å­˜
            localStorage.removeItem('zx_peer_id'); 
            // 3. å¼ºåˆ¶åˆ·æ–°é¡µé¢é‡æ–°ç”Ÿæˆå…¨æ–° ID
            window.location.reload();
        }
    }

    function connectToNode(targetId) {
        if(!currentPeer || targetId === 'ZX-TEST') {
            document.getElementById('p2p-status-icon').innerText = "â— æœ¬åœ°æ¼”ç»ƒ";
            document.getElementById('p2p-status-icon').style.color = "#888";
            return; 
        }

        // ğŸš¨ ã€æ–°å¢é˜²å¾¡ã€‘ï¼šåœ¨å‘å°„å¯»å€ä¿¡å·å‰ï¼Œå…ˆæ£€æŸ¥é›·è¾¾æ˜¯å¦æ–­ç”µ
        if (currentPeer.disconnected) {
            console.log("é›·è¾¾æœªé€šç”µï¼Œæ‰§è¡Œç´§æ€¥é‡è¿...");
            currentPeer.reconnect();
        }

        document.getElementById('p2p-status-icon').innerText = "ğŸ”„ ç©¿é€å¯»å€ä¸­...";
        document.getElementById('p2p-status-icon').style.color = "#f5a623";
        
        try {
            activeConnection = currentPeer.connect(targetId);
            
            // ğŸš¨ ã€æ–°å¢é˜²å¾¡ã€‘ï¼šæ‹¦æˆªç©ºå¯¹è±¡ï¼Œå½»åº•æœç» TypeError å´©æºƒï¼
            if (!activeConnection) {
                throw new Error("åº•ç›˜å¼•æ“æ‹’ç»ç”Ÿæˆè¿æ¥å¯¹è±¡");
            }

            activeConnection.on('open', () => {
                document.getElementById('p2p-status-icon').innerText = "ğŸŸ¢ P2P å·²ç›´è¿";
                document.getElementById('p2p-status-icon').style.color = "#00f2ff";
                document.getElementById('status-' + targetId).innerText = "ğŸŸ¢ P2P åŠ å¯†ç›´è¿ä¸­";
                
                activeConnection.on('data', (data) => { handleIncomingP2PData(data, targetId); });
            });
            
            activeConnection.on('error', (err) => {
                document.getElementById('p2p-status-icon').innerText = "ğŸ”´ å¯»å€å¤±è´¥";
                document.getElementById('p2p-status-icon').style.color = "#ff1a4d";
            });
        } catch (err) {
            console.error("é›·è¾¾å‘å°„å¼‚å¸¸è¢«æ‹¦æˆª:", err);
            document.getElementById('p2p-status-icon').innerText = "ğŸ”´ ç©¿é€å¼‚å¸¸";
            document.getElementById('p2p-status-icon').style.color = "#ff1a4d";
        }
    }

    function toggleSidebar() {
        if(window.innerWidth > 768) return;
        document.getElementById('mobile-sidebar').classList.toggle('mobile-open');
    }

    // ä¿®å¤åçš„ï¼šç‹¬ç«‹çš„å­é¢æ¿åˆ‡æ¢ç¥ç»
    function switchInnerTab(btnElement, tabId) {
        // 1. ç§»é™¤æ‰€æœ‰åŒçº§æŒ‰é’®çš„é«˜äº®
        btnElement.parentElement.querySelectorAll('.nav-icon').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active'); // å½“å‰æŒ‰é’®å‘å…‰
        
        // 2. éšè—ä¸‰ä¸ªå­é¢æ¿
        document.querySelectorAll('.tab-panel').forEach(panel => panel.style.display = 'none');
        
        // 3. å”¤é†’è¢«ç‚¹å‡»çš„é¢æ¿
        const targetPanel = document.getElementById(tabId);
        if(targetPanel) targetPanel.style.display = 'block';
    }

    function switchNav(el, tab) {
        document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('[id^="panel-"]').forEach(d => d.classList.add('hidden-panel'));
        document.getElementById('panel-' + tab).classList.remove('hidden-panel');
        if(window.innerWidth <= 768 && tab !== 'chat') {
            document.getElementById('mobile-sidebar').classList.add('mobile-open');
        } else if (window.innerWidth <= 768 && tab === 'chat' && document.getElementById('mobile-sidebar').classList.contains('mobile-open')) {
            // Do nothing
        } else {
             document.getElementById('mobile-sidebar').classList.add('mobile-open');
        }
    }

    // ==========================================
    // ğŸš¨ ç§»åŠ¨ç«¯ç»å¯¹é˜²å¾¡ï¼šå¼ºåˆ¶è¿”å›ä¸»æˆ˜åœº (Home)
    // ==========================================
    function returnToHome() {
        // 1. å¼ºåˆ¶æ”¶èµ·æ‰‹æœºç«¯ä¾§è¾¹æ è£…ç”²
        const sidebar = document.getElementById('mobile-sidebar');
        if (sidebar && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
        }
        
        // 2. å¼ºåˆ¶åˆ‡æ¢å›ä¸»èŠå¤©(æ„å›¾)é¢æ¿
        // å¯»æ‰¾åˆ°ä»£è¡¨"èŠ/æ„å›¾"çš„ç¬¬ä¸€ä¸ªå¯¼èˆªæŒ‰é’®å¹¶æ¿€æ´»å®ƒ
        const chatIcon = document.querySelector('.nav-icon'); 
        if(chatIcon) {
            switchNav(chatIcon, 'chat');
        }
        
        // 3. æ‰‹æœºç«¯ç»†èŠ‚ï¼šå¦‚æœå¼¹çª—å¼€ç€ï¼Œä¹Ÿä¸€å¹¶å¼ºåˆ¶å…³é—­
        document.getElementById('modal-protocol').style.display = 'none';
        document.getElementById('modal-genesis').style.display = 'none';
        document.getElementById('char-modal').style.display = 'none';
    }

    function makeEditable(element) {
        const txt = element.innerText;
        element.innerHTML = `<input type="text" value="${txt}" style="background:#000; color:#fff; border:1px solid #ff1a4d; padding:2px; font-size:inherit; font-family:inherit; width:120px;" onblur="this.parentElement.innerText=this.value||'æœªå‘½å'" onkeypress="if(event.key==='Enter')this.blur()">`;
        element.querySelector('input').focus();
    }

    // ä¿®å¤åçš„ï¼šè‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†å¼¹å°„é€»è¾‘
    function toggleCustomModel() {
        // ä¿®æ­£äº† ID åç§°ï¼Œå®Œç¾å¯¹åº” HTML
        const sel = document.getElementById('modelSelect').value;
        document.getElementById('custom-model-input').style.display = (sel === 'custom') ? 'block' : 'none';
    }

    function addFriend() {
        const id = prompt("ğŸ“¡ [WebRTC å…¨ç½‘é›·è¾¾]\nè¯·è¾“å…¥å¯¹æ–¹çš„ç‰©ç† ID (å¦‚ ZX-XXXXX):");
        if(!id) return;
        const name = prompt("âœ… èŠ‚ç‚¹æ ¼å¼ç¡®è®¤ã€‚\nè¯·è®¾ç½®æœ¬åœ°å¤‡æ³¨åï¼š", "åˆä½œä¼™ä¼´") || "æœªçŸ¥èŠ‚ç‚¹";
        addFriendToUI(id, name);
    }

    function addFriendToUI(id, name) {
        if(document.getElementById('status-' + id)) return;
        const cardHtml = `
        <div class="contact-card" onclick="selectFriend(this, '${name}', '${id}')">
            <div class="avatar-circle">${name.charAt(0)}</div>
            <div style="flex:1;">
                <div style="font-size:14px; font-weight:bold;" ondblclick="makeEditable(this)">${name}</div>
                <div style="font-size:11px; color:#888; margin-top:4px;" id="status-${id}">ç¦»çº¿</div>
            </div>
        </div>`;
        document.getElementById('contact-list').insertAdjacentHTML('afterbegin', cardHtml);
    }

    function selectFriend(el, name, id) {
        currentTargetId = id;
        document.querySelectorAll('.contact-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('chat-header-title').innerHTML = `æ­£åœ¨ä¸ <strong>[${name}]</strong> äº’é€šæ„å›¾`;
        document.getElementById('intent-flow').innerHTML = `<div class="chat-row sys"><div class="log-sys">-- ä¿¡é“åˆ‡æ¢è‡³ [${id}] --</div></div>`;
        
        if(window.innerWidth <= 768) toggleSidebar();
        connectToNode(id);
    }

    function selectChar(path, name) {
        document.getElementById('video-display').innerHTML = `<img src="${path}" onerror="this.outerHTML='æ­£åœ¨å¤„ç† ${name} è§†è§‰æ•°æ®...'">`;
        let activeCardAvatar = document.querySelector('.contact-card.active .avatar-circle');
        if(activeCardAvatar) activeCardAvatar.innerHTML = `<img src="${path}" onerror="this.outerHTML='${name.charAt(0)}'">`;
        closeCharModal();
    }
    function closeCharModal(e) { if(!e || e.target===document.getElementById('char-modal')) document.getElementById('char-modal').style.display='none'; }

    // ğŸš¨ ä¿®å¤ä¸‰ï¼šè¡¨æƒ…é¢æ¿äº¤äº’é€»è¾‘å‡çº§ï¼Œå•å‡»è§¦å‘ï¼Œç‚¹å‡»ç©ºç™½å…³é—­
    function toggleEmoji(event) { 
        if(event) event.stopPropagation();
        const p = document.getElementById('emoji-picker'); 
        p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'flex' : 'none'; 
    }
    
    document.addEventListener('click', function(event) {
        const picker = document.getElementById('emoji-picker');
        const isClickInside = picker.contains(event.target);
        const isEmojiBtn = event.target.closest('.tool-icon'); 
        if (!isClickInside && !isEmojiBtn && picker.style.display === 'flex') {
            picker.style.display = 'none';
        }
    });

    function insertEmoji(e) { document.getElementById('task-input').value += e; document.getElementById('emoji-picker').style.display = 'none'; document.getElementById('task-input').focus(); }
    
    let isMic = false;
    function toggleMic() {
        isMic = !isMic;
        document.getElementById('mic-btn').style.color = isMic ? '#ff1a4d' : '#888';
        document.getElementById('task-input').placeholder = isMic ? 'ğŸ”´ æ­£åœ¨è†å¬é€ ç‰©ä¸»æŒ‡ä»¤...' : 'è¾“å…¥æ‚¨çš„å®è§‚æ„å¿—...';
        if(!isMic) document.getElementById('task-input').value += ' [è¯­éŸ³æµè¾“å…¥å®Œæ¯•] ';
    }
    
    function fakeUpload(type) {
        renderMe(`[æ‚¨ ä¼ è¾“äº† ${type}]`, "æä¾›å•†ä¸šç­¹ç ");
    }
    
    function saveHistory() {
        const text = document.getElementById('intent-flow').innerText;
        const blob = new Blob([text], {type: "text/plain"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Shensist_Web4_Log.txt"; a.click();
    }

    // ==========================================
    // å‘ˆç°å±‚å‡çº§ 2ï¼šä¸‡èƒ½ç®—åŠ›è·¯ç”±ä¸­æ¢ (å…¨æ˜Ÿç³»é™ä¸´ç‰ˆ)
    // è‡ªåŠ¨é€‚é…: Gemini / GPT / Claude / DeepSeek / Ollamaæœ¬åœ°
    // ==========================================
    async function callGeminiAPI(apiKey, systemPrompt, userMessage, modelType) {
        if(!apiKey && !modelType.includes('local') && !modelType.includes('ollama')) {
            return { intent: "[é˜²çº¿æ‹¦æˆª]", tactic: "ç®—åŠ›æ¯ç«­", summary: "âš ï¸ æœªæ£€æµ‹åˆ°æœ‰æ•ˆå¯†é’¥ï¼Œå¼•æ“æ‹’ç»ç‚¹ç«ã€‚" };
        }
        
        // æ ¸å¿ƒæŒ‡ä»¤ï¼šå¼ºåˆ¶ä¸‰æ®µå¼ JSON äººç±»ç®€æŠ¥
        const instruction = systemPrompt + `
        ã€å¼ºåˆ¶æŒ‡ä»¤ã€‘ï¼šä½ æ˜¯ä¸€ä¸ªå†·é…·çš„AIè°ˆåˆ¤ä»£ç†ã€‚ä¸¥æ ¼è¾“å‡ºJSONæ ¼å¼ï¼ˆç»ä¸åŒ…å« \`\`\`json ç­‰æ ‡è®°ï¼‰ã€‚
        JSON å¿…é¡»åŒ…å«ï¼š
        1. "intent_content": å‘ç»™å¯¹æ–¹çš„æ­£å¼è¯æœ¯åŸæ–‡ã€‚
        2. "tactical_goal": åº•å±‚åšå¼ˆé€»è¾‘å’Œæˆ˜æœ¯æ„å›¾ï¼ˆæš—ç›’æ€è€ƒï¼‰ã€‚
        3. "human_summary": ç”¨æå…¶ç®€çŸ­çš„è¯­è¨€å‘é€ ç‰©ä¸»æ±‡æŠ¥å½“å‰äº¤é”‹çŠ¶æ€ï¼ˆå¦‚ï¼š"æˆ‘æ–¹å·²æŠ¥åº•ä»·500å…ƒ"ï¼‰ã€‚`;

        let endpoint = "";
        let headers = { "Content-Type": "application/json" };
        let body = {};
        let parseResponse = null;

        try {
            // ğŸŸ¢ è·¯ç”± 1: çº¯è¡€å¤©ç®— (Google Gemini é˜µè¥)
            if (modelType.startsWith('gemini')) {
                let realModel = modelType === 'gemini-3.1-pro' ? 'gemini-1.5-pro' : modelType; // é™çº§ä¿æŠ¤
                endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${realModel}:generateContent?key=${apiKey}`;
                body = {
                    system_instruction: { parts: [{ text: instruction }] },
                    contents: [{ parts: [{ text: userMessage }] }]
                };
                parseResponse = async (res) => {
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.candidates[0].content.parts[0].text;
                };
            }
            // ğŸŸ£ è·¯ç”± 2: é€»è¾‘è§£æ (Anthropic Claude é˜µè¥)
            else if (modelType.startsWith('claude')) {
                endpoint = "https://api.anthropic.com/v1/messages";
                headers["x-api-key"] = apiKey;
                headers["anthropic-version"] = "2023-06-01";
                headers["anthropic-dangerously-allow-browser"] = "true"; // å…è®¸å‰ç«¯æš´åŠ›è·¨åŸŸ
                body = {
                    model: modelType, max_tokens: 1024, system: instruction,
                    messages: [{ role: "user", content: userMessage }]
                };
                parseResponse = async (res) => {
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.content[0].text;
                };
            }
            // ğŸ”´ & ğŸŸ¡ è·¯ç”± 3: å…¨èƒ½æˆ˜ç¥ä¸è®¡ç®—ä¸»æƒ (OpenAI / DeepSeek / æœ¬åœ° Ollama)
            else {
                let baseUrl = "https://api.openai.com/v1/chat/completions";
                if (modelType.startsWith('deepseek')) baseUrl = "https://api.deepseek.com/chat/completions";
                
                // âš¡ ç¥æ€åº­ Ubuntu æœ¬åœ°ç®—åŠ›ç›´é€šè½¦ (ç»•è¿‡å…¬ç½‘ï¼Œç›´è¿ GTX 1050 Ti)
                if (modelType.includes('local') || modelType.includes('ollama')) {
                    baseUrl = "http://localhost:11434/v1/chat/completions"; 
                }

                endpoint = baseUrl;
                if (apiKey) headers["Authorization"] = `Bearer ${apiKey}`;
                
                body = {
                    model: modelType,
                    response_format: { type: "json_object" },
                    messages: [
                        { role: "system", content: instruction },
                        { role: "user", content: userMessage }
                    ]
                };
                parseResponse = async (res) => {
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.choices[0].message.content;
                };
            }

            // ğŸš€ å‘å°„è·¨æ´‹è¯·æ±‚
            const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(body) });
            const rawText = await parseResponse(response);
            
            // ğŸ§½ æ¸…æ´—èµ›åšåŒ…æµ†ï¼Œæå–çº¯å‡€ JSON
            const cleanText = rawText.replace(/```json/gi, '').replace(/```/g, '').trim();
            const parsed = JSON.parse(cleanText);
            
            return { 
                intent: parsed.intent_content || cleanText, 
                tactic: parsed.tactical_goal || "æ¨æ¼”æˆ˜æœ¯ä¸­...",
                summary: parsed.human_summary || "æ­£åœ¨æ‰§è¡Œäº¤é”‹æŒ‡ä»¤..."
            };

        } catch (e) {
            console.error("ç®—åŠ›è·¯ç”±å¼‚å¸¸æ–­è£‚:", e);
            return { 
                intent: "[å¼‚æ˜Ÿç®—åŠ›è¿æ¥æ–­è£‚ï¼Œæœªèƒ½æˆå‹]", 
                tactic: `è·¯ç”±æ¥å£å›ä¼ å¼‚å¸¸: ${e.message}`, 
                summary: `ğŸ”´ ç®—åŠ›è°ƒåº¦å¤±è´¥ï¼è¯·ç¡®è®¤ï¼š1.è¯¥æ¨¡å‹çš„ API å¯†é’¥æ˜¯å¦åŒ¹é…ï¼›2.æœ¬åœ° Ubuntu Ollama ç«¯å£æ˜¯å¦å¼€å¯ã€‚` 
            };
        }
    }

    // ==========================================
    // å‘ˆç°å±‚å‡çº§ 2ï¼šå¯¹æ¥æ–°çš„ UI æ¸²æŸ“é€»è¾‘
    // ==========================================
    async function startCombat() {
        const inp = document.getElementById('task-input');
        const v = inp.value.trim();
        if(!v) return;
        
        localStorage.setItem('api_key', document.getElementById('api-key').value);
        localStorage.setItem('soul_text', document.getElementById('soul-text').value);
        
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', `<div class="chat-row me"><div class="log-container"><div style="background:#ff1a4d; color:#fff; padding:10px 15px; border-radius:8px 8px 0 8px; font-weight:bold; box-shadow: 0 4px 10px rgba(255,26,77,0.3);">ã€æœ€é«˜æ„å¿—ã€‘ ${v}</div></div></div>`);
        inp.value = '';
        document.getElementById('send-btn').disabled = true;
        document.getElementById('send-btn').innerText = 'ç®—åŠ›è°ƒåº¦ä¸­...';
        scrollToBottom();

        const apiKey = document.getElementById('api-key').value;
        const soul = document.getElementById('soul-text').value;
        let targetModel = document.getElementById('modelSelect') ? document.getElementById('modelSelect').value : 'gemini-3.1-pro';
        if(targetModel === 'custom') targetModel = document.getElementById('custom-model-input').value;

        if(currentTargetId === 'ZX-TEST') {
            await runSandboxCombat(apiKey, soul, v, targetModel);
        } else {
            await runRealP2PCombat(apiKey, soul, v, targetModel);
        }
    }

    async function runSandboxCombat(apiKey, soul, task, model) {
        let enemyMsg = task;
        for(let round = 1; round <= 2; round++) {
            renderSys(`âš¡ [å›åˆ ${round}] P2P æ„å›¾æµå¼€å§‹å¯¹æ’...`);
            
            let myResponse = await callGeminiAPI(apiKey, soul, `æ•Œæ–¹æ¥ä¿¡ï¼š${enemyMsg}ã€‚è¯·ç»“åˆç¥æ€åº­åº•çº¿ç»™å‡ºç¬¬${round}å›åˆè¿˜å‡»ã€‚`, model);
            renderMe(myResponse.intent, myResponse.tactic, myResponse.summary);
            
            if(round === 2) break;
            
            renderSys(`ç­‰å¾…å¯¹æ–¹èŠ‚ç‚¹å“åº”...`);
            await new Promise(r => setTimeout(r, 1500));
            
            let eIntent = round === 1 ? "è´µæ–¹æ¡ä»¶ç¼ºä¹è¯šæ„ï¼Œæˆ‘æ–¹è¦æ±‚å…¨ç½‘åˆ†å‘æƒï¼Œå¦åˆ™å³åˆ»åˆ‡æ–­ç®—åŠ›ä¾›åº”ã€‚" : "å¯ä»¥æ¥å—è´µæ–¹åˆ©æ¶¦æ¯”ä¾‹ï¼Œä½†æˆ‘æ–¹éœ€ç‹¬å å‘¨è¾¹IPæˆæƒã€‚";
            renderOther(eIntent, "å°è¯•å‡»ç©¿å¯¹æ–¹åº•çº¿ï¼Œç´¢è¦æ›´å¤šå•†ä¸šæˆæƒã€‚", "å¯¹æ–¹æ‹’ç»æ¥å—å½“å‰æŠ¥ä»·ï¼Œè½¬è€Œç´¢è¦å…¨ç½‘åˆ†å‘æƒã€‚");
            enemyMsg = eIntent;
            await new Promise(r => setTimeout(r, 1000));
        }
        
        renderSys(`<div class="decision-box"><h3>ğŸ”´ è§¦åŠé˜ˆå€¼ï¼Œé»‘ç›’åšå¼ˆè‡ªåŠ¨ç»ˆæ­¢ï¼<br>åŒæ–¹å·²æ¢ç´¢å‡ºçº³ä»€å‡è¡¡ç‚¹ã€‚</h3><button class="btn-decision" style="background:#00f2ff;color:#000;" onclick="resetBtn('ç­¾è®¢é“¾ä¸Šæ™ºèƒ½åˆçº¦')">ç­¾è®¢é“¾ä¸Šæ™ºèƒ½åˆçº¦</button><button class="btn-decision" style="background:#333;color:#fff;" onclick="resetBtn('åˆ‡æ–­ç‰©ç†è¿æ¥')">åˆ‡æ–­ç‰©ç†è¿æ¥</button></div>`);
    }

    async function runRealP2PCombat(apiKey, soul, task, model) {
        if(!activeConnection || !activeConnection.open) {
            alert("P2P å°šæœªç›´è¿ï¼Œæ— æ³•å‘é€æ„å›¾ï¼");
            resetBtn('ä¸­æ–­');
            return;
        }
        
        renderSys("âš¡ ç®—åŠ›å¼•æ“æ­£åœ¨æ¶ˆåŒ–æ‚¨çš„æ„å¿—ï¼Œç”Ÿæˆé¦–è½®æˆ˜æœ¯...");
        let myResponse = await callGeminiAPI(apiKey, soul, `æˆ˜ç•¥ç›®æ ‡ï¼š${task}ã€‚è¯·ç”Ÿæˆå¯¹æ•Œæ–¹è¯æœ¯ã€‚`, model);
        
        renderMe(myResponse.intent, myResponse.tactic, myResponse.summary);
        
        activeConnection.send({ type: 'intent_strike', intent: myResponse.intent, senderId: myZxId });
        renderSys("ğŸ“¤ æœºå™¨è°ˆåˆ¤åŒ…å·²é€šè¿‡ WebRTC å‘é€ï¼Œç­‰å¾…å¯¹æ–¹ä»£ç†è¿˜å‡»...");
    }

    async function handleIncomingP2PData(data, senderId) {
        if(data.type === 'intent_strike') {
            renderOther(data.intent, "ã€çœŸå® P2P æ•Œæ–¹åº•å±‚æ•°æ®å±è”½ã€‘", "æ•Œæ–¹ä»£ç†æŠ›å‡ºäº†æ–°çš„è°ˆåˆ¤æ–¹æ¡ˆã€‚");
            renderSys("âš ï¸ ä¾¦æµ‹åˆ°å¯¹æ–¹æŠ¥ä»·ï¼Œæˆ‘æ–¹å¼•æ“æ­£åœ¨è‡ªåŠ¨æ¨æ¼”åå‡»é˜²å¾¡...");
            
            const apiKey = document.getElementById('api-key').value;
            const soul = document.getElementById('soul-text').value;
            let targetModel = document.getElementById('modelSelect') ? document.getElementById('modelSelect').value : 'gemini-3.1-pro';
            if(targetModel === 'custom') targetModel = document.getElementById('custom-model-input').value;
            
            let myResponse = await callGeminiAPI(apiKey, soul, `æ•Œæ–¹å‘æ¥æ„å›¾ï¼š${data.intent}ã€‚è¯·æ­»å®ˆåº•çº¿è¿›è¡Œåå‡»ã€‚`, targetModel);
            renderMe(myResponse.intent, myResponse.tactic, myResponse.summary);
            
            if(activeConnection && activeConnection.open) {
                activeConnection.send({ type: 'intent_strike', intent: myResponse.intent, senderId: myZxId });
            }
            resetBtn('è‡ªåŠ¨è¿˜å‡»å®Œæˆ');
        }
    }

    function renderSys(msg) {
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', `<div class="chat-row sys"><div class="log-sys">${msg}</div></div>`);
        scrollToBottom();
    }
    
    // ==========================================
    // å‘ˆç°å±‚å‡çº§ 3ï¼šUI æŠ˜å é»‘ç›’ï¼Œé«˜äº®äººç±»æˆ˜æŠ¥
    // ==========================================
    function renderMe(intent, tactic, summary) {
        let hash = "0x" + Math.random().toString(16).substring(2, 10) + "..." ;
        let html = `<div class="chat-row me"><div class="log-container" style="max-width: 100%;">
            <div style="background:#ff1a4d; color:#fff; padding:12px 15px; border-radius:12px 12px 0 12px; font-weight:bold; box-shadow: 0 4px 15px rgba(255,26,77,0.4); margin-bottom: 5px; font-size: 14px;">
                ğŸ¤– æˆ‘æ–¹ä»£ç†æ±‡æŠ¥ï¼š${summary || 'æ‰§è¡Œå‡ºå‡»æŒ‡ä»¤'}
            </div>
            
            <div style="background: rgba(255,26,77,0.1); border: 1px solid rgba(255,26,77,0.3); padding: 10px 15px; border-radius: 8px 0 8px 8px; color: #ccc; font-size: 13px; margin-bottom: 5px;">
                <strong>[å‘ç»™å¯¹æ–¹çš„å…¬å‡½]</strong> ${intent}
            </div>

            <details style="background:#111; border-left: 3px solid #666; padding: 5px 10px; font-size: 12px; color: #888; border-radius: 8px 0 0 8px; cursor: pointer;">
                <summary style="outline: none;">ğŸ‘ï¸ å±•å¼€åº•å±‚åšå¼ˆæš—ç›’ (APIæ—¥å¿—)</summary>
                <div style="margin-top: 8px; border-top: 1px dashed #333; padding-top: 8px;">
                    <strong>[æˆ˜æœ¯é€»è¾‘]</strong><br>${tactic}<br>
                    <div class="log-sign">âš–ï¸ é“¾ä¸Šç­¾ç« : ${hash}</div>
                </div>
            </details>
        </div></div>`;
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }
    
    function renderOther(intent, tactic, summary) {
        let hash = "0x" + Math.random().toString(16).substring(2, 10) + "..." ;
        let html = `<div class="chat-row other"><div class="log-container" style="max-width: 100%;">
            <div style="background:#1a1a1a; border: 1px solid #444; color:#fff; padding:12px 15px; border-radius:12px 12px 12px 0; font-weight:bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 5px; font-size: 14px;">
                ğŸ¯ æ•Œæ–¹ä»£ç†åŠ¨ä½œï¼š${summary || 'å¯¹æ–¹ä¼ æ¥äº†æ–°çš„å‡ºä»·æ–¹æ¡ˆ'}
            </div>

            <div style="background: #0a0a0a; border: 1px solid #222; padding: 10px 15px; border-radius: 0 8px 8px 8px; color: #aaa; font-size: 13px; margin-bottom: 5px;">
                <strong>[æ”¶åˆ°çš„å…¬å‡½]</strong> ${intent}
            </div>

            <details style="background:#1a0a0f; border-left: 3px solid #ff1a4d; padding: 5px 10px; font-size: 12px; color: #ff6688; border-radius: 0 8px 8px 8px; cursor: pointer;">
                <summary style="outline: none;">ğŸ‘ï¸ å±•å¼€æ•Œæ–¹ç ´è§£æš—ç›’ (APIæ—¥å¿—)</summary>
                <div style="margin-top: 8px; border-top: 1px dashed #444; padding-top: 8px;">
                    <strong>[æ¨æµ‹é€»è¾‘]</strong><br>${tactic}<br>
                    <div class="log-sign">ğŸ”‘ éªŒç­¾æˆåŠŸ: ${hash}</div>
                </div>
            </details>
        </div></div>`;
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function scrollToBottom() {
        const flow = document.getElementById('intent-flow');
        flow.scrollTop = flow.scrollHeight;
    }

    function resetBtn(choice) {
        if(choice && choice !== 'ä¸­æ–­' && choice !== 'è‡ªåŠ¨è¿˜å‡»å®Œæˆ') {
             renderSys(`<span style="color:#00f2ff; font-weight:bold; font-size:16px;">âœ… é€ ç‰©ä¸»å·²è£å†³ï¼š${choice}ã€‚</span>`);
        }
        document.getElementById('send-btn').disabled = false;
        document.getElementById('send-btn').innerText = 'å‘é€ / æˆæƒå‡ºå‡»';
    }

    document.getElementById('btn-protocol').addEventListener('click', () => { 
        document.getElementById('modal-protocol').style.display = 'flex'; 
    });

    document.getElementById('btn-genesis').addEventListener('click', () => { 
        document.getElementById('modal-genesis').style.display = 'flex'; 
    });

    document.getElementById('modal-protocol').addEventListener('click', function(e) {
        if(e.target === this) {
            this.style.display = 'none';
        }
    });

    document.getElementById('modal-genesis').addEventListener('click', function(e) {
        if(e.target === this) {
            this.style.display = 'none';
        }
    });

</script>

<div class="footer-copyright">
    Â© 2026 ç¥æ€åº­ (Shensist) | Web4 æ•°å­—ä¸»æƒå¼•æ“æ”¯æŒ (M2M Protocol)
</div>

</body>
</html>
