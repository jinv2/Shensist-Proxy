<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¥æ€åº­ Â· æ™ºä¿¡ç»ˆç«¯</title>
    <link rel="icon" href="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ç¥æ€åº­æ™ºä¿¡">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* è‡ªåŠ¨æ›´æ–° UI ä¸­çš„ LOGO å›¾ç‰‡æº */
        .logo-img {
            width: 120px;
            height: auto;
            content: url("https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png");
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff; font-family: -apple-system, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨æ  */
        .top-bar { height: 50px; background: #050505; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 100; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 16px; }
        .node-id-display { font-family: monospace; color: #888; font-size: 13px; cursor: pointer; padding: 5px; }
        .node-id-display:hover { background: #222; color: #fff; }
        
        /* æ ¸å¿ƒå¸ƒå±€ */
        .app-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* å¯¼èˆªæ  */
        .nav-bar { width: 70px; background: #0a0a0a; border-right: 1px solid #222; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; z-index: 50; }
        .nav-icon { width: 40px; height: 40px; border-radius: 12px; background: #1a1a1a; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #888; font-size: 14px; font-weight: bold; border: 1px solid transparent; transition: 0.3s; }
        .nav-icon.active, .nav-icon:hover { background: #222; color: #fff; border-color: #555; }
        
        /* ä¾§è¾¹é¢æ¿ */
        .sidebar { width: 320px; background: #050505; border-right: 1px solid #222; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; z-index: 40; transition: transform 0.3s ease; }
        .control-group { font-size: 13px; color: #aaa; display: block; margin-top: 15px; margin-bottom: 8px; font-weight: bold; }
        select, input[type="text"], input[type="password"] { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 6px; outline: none; margin-bottom: 15px; }
        textarea.config-text { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 6px; min-height: 100px; resize: none; outline: none; margin-bottom: 15px; }
        textarea::placeholder { color: #666; font-style: italic; }
        
        .contact-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; margin-bottom: 10px; }
        .contact-card.active { border-color: #ff1a4d; background: #1a1114; }
        .avatar-circle { width: 45px; height: 45px; border-radius: 8px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #fff; font-weight:bold; overflow:hidden;}
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ä¸»æˆ˜åœº */
        .main-deck { flex: 1; background: #020202; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-header { height: 60px; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-size: 14px; color: #888; background: #050505; flex-shrink: 0; }
        
        .video-stage { height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 1px solid #1a1a1a; padding: 20px; flex-shrink: 0;}
        .video-box { width: 100%; max-width: 400px; height: 100%; background: #000; border: 1px solid #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #444; margin-bottom: 15px; overflow: hidden; }
        .video-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .stage-btns { display: flex; gap: 10px; flex-shrink: 0; }
        .stage-btn { background: #222; border: 1px solid #444; color: #ddd; padding: 6px 15px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .stage-btn.primary { background: #ff1a4d; color: #fff; border: none; font-weight: bold;}
        
        /* èŠå¤©æµï¼šå®Œç¾å·¦å³é˜µè¥ */
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; font-size: 14px; line-height: 1.6; display: flex; flex-direction: column; }
        .chat-row { display: flex; width: 100%; margin-bottom: 20px; flex-direction: column; }
        .chat-row.me { align-items: flex-end; }
        .chat-row.other { align-items: flex-start; }
        .chat-row.sys { align-items: center; }
        
        .log-container { max-width: 80%; }
        .log-tactic { background: #111; border-left: 3px solid #666; padding: 10px; margin-bottom: 5px; font-size: 12px; color: #aaa; border-radius: 8px 0 0 8px; }
        .log-intent { background: rgba(255,26,77,0.15); border: 1px solid rgba(255,26,77,0.4); padding: 15px; border-radius: 12px 0 12px 12px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        .log-tactic-enemy { background: #1a0a0f; border-left: 3px solid #ff1a4d; padding: 10px; margin-bottom: 5px; font-size: 12px; color: #ff6688; border-radius: 0 8px 8px 0;}
        .log-intent-enemy { background: #1a1a1a; border: 1px solid #444; padding: 15px; border-radius: 0 12px 12px 12px; color: #ccc; }
        
        .log-sys { text-align: center; color: #888; margin: 15px 0; font-size: 12px; background: #111; padding: 5px 15px; border-radius: 20px; display: inline-block;}
        .log-sign { font-family: monospace; font-size: 10px; color: #f5a623; margin-top: 8px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 5px; }
        .decision-box { text-align: center; background: #0a0a0a; border: 1px solid #ff1a4d; padding: 20px; border-radius: 12px; margin-top: 20px; max-width: 500px; margin-left: auto; margin-right: auto;}
        .btn-decision { padding: 10px 25px; margin: 0 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* è¾“å…¥æ§åˆ¶å° */
        .input-console { position: relative; border-top: 1px solid #222; padding: 15px 20px; background: #050505; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
        .toolbar { display: flex; gap: 15px; margin-bottom: 5px; }
        .tool-icon { color: #888; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .tool-icon:hover { color: #fff; }
        
        #emoji-picker { display:none; position:absolute; bottom:100%; left:20px; margin-bottom:10px; background:#111; border:1px solid #333; padding:10px; border-radius:8px; gap:8px; flex-wrap:wrap; width:300px; max-height: 200px; overflow-y: auto; z-index:999; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        .emoji-btn { cursor:pointer; font-size:22px; padding: 2px; transition: 0.2s; }
        .emoji-btn:hover { transform: scale(1.2); }
        
        .input-wrap { display: flex; gap: 10px; align-items: flex-end; }
        .input-wrap textarea { height: 50px; flex: 1; margin-bottom: 0; background: transparent; border: 1px solid #333; border-radius: 6px; padding: 10px; color: #fff; outline: none; font-family: inherit; resize: none;}
        .btn-launch { padding: 0 20px; height: 50px; background: #ff1a4d; border: none; color: #fff; font-weight: bold; cursor: pointer; border-radius: 6px; }

        /* çº¯å‡€æ³¨å†Œæ¨¡æ€æ¡† (åŒé€‰é¡¹å¡æ»¡è¡€å½’æ¥) */
        .auth-gate { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items:center; justify-content:center; padding: 20px;}
        .auth-card { background: #111; border: 1px solid #333; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; box-shadow: 0 0 40px rgba(255,26,77,0.2); }
        
        /* æ–°çš„ Gate æ ·å¼ */
        .gate-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items:center; justify-content:center; padding: 20px;}
        .gate-box { background: #111; border: 1px solid #333; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; box-shadow: 0 0 40px rgba(255,26,77,0.2); }
        .gate-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #222; }
        .gate-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #555; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .gate-tab:hover { color: #ff1a4d; }
        .gate-box img { transition: transform 0.5s ease; }
        .gate-box img:hover { transform: scale(1.1) rotate(5deg); }
        
        .char-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px;}
        .char-modal { background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; width: 100%; max-width: 600px; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .char-item { background: #1a1a1a; border: 2px solid #222; border-radius: 8px; cursor: pointer; text-align: center; padding: 10px; }
        .char-item:hover { border-color: #ff1a4d; }
        
        .footer-copyright { height: 35px; background: #000; border-top: 1px solid #111; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #555; flex-shrink: 0; }
        .hidden-panel { display: none !important; }

        /* æ‰‹æœºç«¯è‡ªé€‚åº” */
        @media (max-width: 768px) {
            .app-wrapper { flex-direction: column; }
            .nav-bar { flex-direction: row; width: 100%; height: 60px; padding: 0; justify-content: space-around; border-right: none; border-top: 1px solid #222; order: 3; }
            .nav-icon { width: 50px; height: 40px; }
            .sidebar { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 80; transform: translateX(-100%); background: #050505; }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-deck { order: 1; flex: 1; }
            .video-stage { height: 180px; padding: 10px; }
            .char-grid { grid-template-columns: repeat(2, 1fr); }
            .chat-header::before { content: 'â˜° å±•å¼€é…ç½®'; color: #ff1a4d; font-weight: bold; cursor: pointer; margin-right: 10px; border: 1px solid #ff1a4d; padding: 2px 6px; border-radius: 4px;}
        }
    </style>
</head>
<body>
    <div id="gate" class="gate-overlay">
        <div class="gate-box">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png" 
                     alt="ç¥æ€åº­" 
                     style="width:80px; height:80px; border-radius:10px; box-shadow: 0 0 15px rgba(255,26,77,0.5);"
                     onerror="this.src='logo_ts.png'">
                <h2 style="margin-top:10px; color:#fff; letter-spacing:2px;">ç¥æ€åº­ Â· æ™ºä¿¡</h2>
            </div>

            <div class="gate-tabs">
                <div class="gate-tab" id="tab-apply" onclick="gateTab('apply')" style="color:#ff1a4d; border-bottom:2px solid #ff1a4d;">ç”³è¯·æ™ºä¿¡å·</div>
                <div class="gate-tab" id="tab-login" onclick="gateTab('login')">éªŒè¯ä¸»æƒå°ç« </div>
            </div>
            
            <div id="form-apply">
                <div style="font-size:12px; color:#aaa; line-height:1.8; background:#1a1a1a; padding:15px; border-radius:6px; margin-bottom:15px;">
                    ã€Šç¥æ€åº­ Web4 é€ ç‰©ä¸»åè®®ã€‹<br>
                    1. æœ¬ç³»ç»Ÿçº¯é™æ€è¿è¡Œï¼Œ0æœåŠ¡å™¨ï¼Œéƒ¨ç½²è‡³ GitHub Pagesã€‚<br>
                    2. èŠ‚ç‚¹é‡‡ç”¨ WebRTC ç©¿é€ï¼Œæ•°å­—å°ç« ä»…å­˜äºæœ¬åœ°ç¼“å­˜ã€‚<br>
                    3. åˆ‡å‹¿æ³„éœ²æ‚¨çš„ API Key ä¸ç‰©ç† IDã€‚
                </div>
                <label style="font-size:12px; color:#aaa; display:flex; align-items:center; gap:8px; margin-bottom:20px; cursor:pointer;">
                    <input type="checkbox" id="agree-chk" checked> æˆ‘äº†è§£ç‰©ç†å°ç« çš„ä¸å¯ç¯¡æ”¹æ€§
                </label>
                
                <div id="success-box" style="display:none; background:#000; border:1px dashed #ff1a4d; padding:15px; color:#ff1a4d; margin-bottom:20px; font-family:monospace; text-align:center;">
                    ç”ŸæˆæˆåŠŸ! æ‚¨çš„æ™ºä¿¡å·ä¸º: <b id="new-zx-id">ZX-XXXXX</b><br>
                    <button class="stage-btn primary" style="margin-top:10px; width: 100%; padding: 10px;" onclick="enterSystem()">è¿›å…¥ç¥æ€åº­</button>
                </div>
                <button id="forge-btn" onclick="forgeSeal()" style="width:100%; padding:14px; background:#ff1a4d; border:none; color:#fff; font-weight:bold; cursor:pointer; border-radius:6px;">âš¡ é”»é€ æœ¬åœ°ä¸“å±å°ç« å¹¶ç™»å…¥</button>
            </div>

            <div id="form-login" style="display:none; text-align:center; padding:20px 10px;">
                <span style="font-size: 40px;">ğŸ’¾</span>
                <div style="font-size:13px; color:#aaa; margin:15px 0;">è¯·å¯¼å…¥æ‚¨å¤‡ä»½çš„ <strong style="color:#00f2ff;">.shensist</strong> æ ¸å¿ƒå°ç« </div>
                <button class="stage-btn primary" onclick="document.getElementById('seal-upload').click()">ğŸ“‚ å¯¼å…¥æ•°å­—å°ç« </button>
                <input type="file" id="seal-upload" accept=".shensist" style="display:none;" onchange="importSeal(this)">
            </div>
        </div>
    </div>

    <div id="char-modal" class="char-modal-overlay" onclick="closeCharModal(event)">
        <div class="char-modal" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 15px; margin-bottom: 20px;">
                <h3 style="margin:0;">é€‰æ‹©æ•°å­—åˆ†èº«</h3>
                <button onclick="closeCharModal()" style="background:none; border:none; color:#888; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div class="char-grid">
                <div class="char-item" onclick="selectChar('./é‡é».png', 'é‡é»')"><span style="font-size:24px;">ğŸ¦Š</span><br>é‡é» (ä¹å°¾ç‹)</div>
                <div class="char-item" onclick="selectChar('./é’é»›.png', 'é’é»›')"><span style="font-size:24px;">ğŸ</span><br>é’é»› (é’è›‡ç²¾)</div>
                <div class="char-item" onclick="selectChar('./é©¬é¾™.png', 'é©¬é¾™')"><span style="font-size:24px;">ğŸ‰</span><br>é©¬é¾™ (çœŸé¾™)</div>
                <div class="char-item" onclick="selectChar('./æ¶‚å±±å½±.png', 'æ¶‚å±±å½±')"><span style="font-size:24px;">ğŸ¦…</span><br>æ¶‚å±±å½±</div>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <div class="brand">
            <div style="width:24px; height:24px; border-radius:50%; overflow:hidden; border:1px solid #ff1a4d;">
                <img src="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png" 
                     style="width:50px; height:50px; border-radius:8px;" 
                     onerror="this.src='logo_ts.png'">
            </div>
            ç¥æ€æ™ºèƒ½ä½“ Â· æ™ºä¿¡
        </div>
        <div class="node-id-display" id="top-id" onclick="copyMyId()">ID: æ¢æµ‹ä¸­...</div>
    </div>

    <div class="app-wrapper">
        <div class="nav-bar">
            <div class="nav-icon active" onclick="switchNav(this, 'chat')" title="èŠ">ğŸ’¬</div>
            <div class="nav-icon" onclick="switchNav(this, 'friends')" title="å‹">ğŸ‘¥</div>
            <div class="nav-icon" onclick="switchNav(this, 'me')" title="æˆ‘">ğŸ‘¤</div>
            <div class="nav-icon" onclick="switchNav(this, 'settings')" title="è®¾">âš™ï¸</div>
        </div>

        <div class="sidebar" id="mobile-sidebar">
            <div style="padding: 20px; text-align: center; border-bottom: 1px solid #222;">
                <img src="https://raw.githubusercontent.com/jinv2/Shensist-Proxy/main/logo_ts.png" 
                     alt="LOGO" 
                     style="width:50px; height:50px; border-radius:8px;" 
                     onerror="this.src='logo_ts.png'">
                <div style="font-size: 12px; color: #ff1a4d; margin-top: 8px; font-weight: bold; letter-spacing: 1px;">SHENSIST</div>
            </div>

            <div class="nav-icons">
                <div class="nav-icon active" onclick="switchNav(this, 'chat')">æ„å›¾</div>
                <div class="nav-icon" onclick="switchNav(this, 'contacts')">å¯»å€</div>
                <div class="nav-icon" onclick="switchNav(this, 'settings')">ç®—åŠ›</div>
            </div>

            <div id="panel-chat">
                <div style="font-weight:bold; font-size:14px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    æ™ºä¿¡é€šè®¯å½• <button class="stage-btn" onclick="addFriend()" style="padding:4px 8px; border-color:#ff1a4d; color:#ff1a4d;">+ å¯»å€</button>
                </div>
                
                <div id="contact-list">
                    <div class="contact-card active" onclick="selectFriend(this, 'å•†åŠ¡è°ˆåˆ¤ Agent', 'ZX-TEST')">
                        <div class="avatar-circle" id="my-avatar">èµ„</div>
                        <div style="flex:1;">
                            <div style="font-size:14px; font-weight:bold;" ondblclick="makeEditable(this)">å•†åŠ¡è°ˆåˆ¤ Agent</div>
                            <div style="font-size:11px; color:#888; margin-top:4px;" id="status-ZX-TEST">å†…ç½®æµ‹è¯•èŠ‚ç‚¹</div>
                        </div>
                    </div>
                </div>

                <label class="control-group">å†³ç­–ç®—åŠ›çŸ©é˜µ (2026ç‰ˆ)</label>
                <select id="model-select" onchange="toggleCustomModel()">
                    <option value="gemini-3.1-pro-preview">Gemini 3.1 Pro (å¤©ç®—Â·é€ ç‰©å¼•æ“)</option>
                    <option value="gemini-3.1-flash-preview">Gemini 3.1 Flash (å¤©ç®—Â·ç¬æ¯)</option>
                    <option value="deepseek-chat">DeepSeek-V3 (é€šç”¨æ‹‰æ‰¯)</option>
                    <option value="custom">- è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§° -</option>
                </select>
                <input type="text" id="custom-model-input" style="display:none;" placeholder="åœ¨æ­¤è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹ ID">

                <label class="control-group">ç®—åŠ›å‡­è¯ (API Key)</label>
                <input type="password" id="api-key" placeholder="å¡«å…¥çœŸå® API å¯†é’¥ (æœ¬åœ°åŠ å¯†å­˜å‚¨)">

                <label class="control-group">è¡ŒåŠ¨çº²é¢† (æœ€é«˜å®ªæ³•)</label>
                <textarea class="config-text" id="soul-text" placeholder="ã€æ ¸å¿ƒèº«ä»½ã€‘ï¼šç¥æ€åº­å…¨æƒä»£è¡¨&#10;ã€æ­»å®ˆåº•çº¿ã€‘ï¼šç»ä¸æ¥å—30%ä»¥ä¸‹åˆ©æ¶¦åˆ†æˆï¼Œè‹¥å¯¹æ–¹æ–½å‹ï¼Œç”¨ã€Šå±±æµ·ç»ã€‹éšå–»åå‡»ï¼Œå¯å‡ºè®©å‘¨è¾¹å®£å‘æƒä½œä¸ºç­¹ç ã€‚"></textarea>
                
                <button class="stage-btn primary" style="width:100%; display:none; margin-top:10px;" id="close-sidebar-btn" onclick="toggleSidebar()">ç¡®è®¤é…ç½®å¹¶è¿”å›æˆ˜åœº</button>
            </div>

            <div id="panel-friends" class="hidden-panel">
                <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">ğŸŒ P2P å…¨ç½‘é›·è¾¾</h3>
                <div style="background:#111; border:1px solid #222; border-radius:8px; padding:15px; color:#ccc; font-size:13px; margin-top:15px; line-height: 1.6;">
                    æ‚¨çš„æµè§ˆå™¨å·²æ¥å…¥å…¨çƒ WebRTC å¯»å€ç½‘ç»œã€‚è¾“å…¥å¯¹æ–¹çš„ ZX-IDï¼Œå³å¯æ— è§†ç‰©ç†è·ç¦»å‘èµ·ç«¯åˆ°ç«¯åŠ å¯†æ¡æ‰‹ï¼Œæ•°æ®ç»ä¸ç»è¿‡ä¸­å¿ƒæœåŠ¡å™¨ã€‚
                </div>
            </div>

            <div id="panel-me" class="hidden-panel">
                <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">ğŸ›¡ï¸ æˆ‘çš„æ•°å­—ä¸»æƒ</h3>
                <div style="background:#1a1114; border:1px solid #ff1a4d; padding:20px; border-radius:8px; margin:20px 0; text-align:center;">
                    <div style="font-size:30px; margin-bottom:10px;">ğŸ›¡ï¸</div>
                    <h4 style="color:#fff; margin-top:0;">çº¯å‰ç«¯é˜²æŠ¤å·²å¼€å¯</h4>
                    <p style="font-size:12px; color:#aaa; margin-bottom:20px;">æ‚¨çš„æ•°æ®å·²æ·±åº¦ç»‘å®šè‡³å½“å‰æµè§ˆå™¨ç¼“å­˜ã€‚è‹¥éœ€æ›´æ¢è®¾å¤‡ï¼Œè¯·å¯¼å‡ºå°ç« ã€‚</p>
                    <button class="stage-btn primary" onclick="exportSealBtn()" style="padding:10px 20px;">ğŸ“¥ å¯¼å‡ºæ ¸å¿ƒå°ç«  (.shensist)</button>
                </div>
                <button class="stage-btn" style="width: 100%;" onclick="if(confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæœ¬åœ°æ‰€æœ‰å‡­è¯ï¼')){localStorage.clear(); location.reload();}">é”€æ¯æœ¬åœ°å°ç« å¹¶é‡å¯</button>
            </div>

            <div id="panel-settings" class="hidden-panel">
                <h3 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">âš™ï¸ ç½‘ç»œå‚æ•°</h3>
                <label class="control-group">åº•å±‚é€šä¿¡åè®®</label>
                <input type="text" value="PeerJS (WebRTC DataChannel)" disabled style="color:#888;">
                <label class="control-group">å¤§æ¨¡å‹åšå¼ˆå›åˆä¸Šé™</label>
                <input type="number" value="3">
            </div>
        </div>

        <div class="main-deck">
            <div class="chat-header" onclick="toggleSidebar()">
                <span id="chat-header-title">æ­£åœ¨ä¸ [å•†åŠ¡è°ˆåˆ¤ Agent] äº’é€šæ„å›¾</span><span id="p2p-status-icon" style="color:#ff1a4d;">â— ç¦»çº¿æ¼”ç»ƒ</span>
            </div>
            
            <div class="video-stage">
                <div class="video-box" id="video-display">ç­‰å¾…æŒ‡ä»¤...</div>
                <div class="stage-btns">
                    <button class="stage-btn" onclick="document.getElementById('real-img-up').click()">ğŸ“ ä¸Šä¼ å½¢è±¡</button>
                    <button class="stage-btn" onclick="document.getElementById('char-modal').style.display='flex'">ğŸ­ é€‰æ‹©å½¢è±¡</button>
                    <button class="stage-btn primary" onclick="alert('çº¯å‰ç«¯ P2P å¼•æ“ä¸ API è·¯ç”±å·²å®Œå…¨å°±ç»ªï¼')">ğŸ“ å¼€å¯ç®—åŠ›</button>
                </div>
            </div>

            <div class="chat-area" id="intent-flow">
                <div class="chat-row sys"><div class="log-sys">-- ç‰©ç†ä¿¡é“åˆå§‹åŒ–å®Œæˆï¼ŒåŸºäºçº¯æµè§ˆå™¨ WebRTC --</div></div>
            </div>

            <div class="input-console">
                <div class="toolbar">
                    <span class="tool-icon" onclick="toggleEmoji()">ğŸ˜Š è¡¨æƒ…</span>
                    <span class="tool-icon" id="mic-btn" onclick="toggleMic()">ğŸ¤ è¯­éŸ³</span>
                    <span class="tool-icon" onclick="document.getElementById('real-img-up').click()">ğŸ–¼ï¸ å›¾ç‰‡</span>
                    <span class="tool-icon" onclick="document.getElementById('real-file-up').click()">ğŸ“„ æ–‡ä»¶</span>
                    <span class="tool-icon" onclick="saveHistory()">ğŸ’¾ å¯¼å‡ºæ—¥å¿—</span>
                    
                    <input type="file" id="real-img-up" accept="image/*" style="display:none;" onchange="fakeUpload('å›¾ç‰‡è§†è§‰æµ')">
                    <input type="file" id="real-file-up" style="display:none;" onchange="fakeUpload('å•†ä¸šæœºå¯†æ–‡ä»¶')">
                    
                    <div id="emoji-picker">
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜ƒ')">ğŸ˜ƒ</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜„')">ğŸ˜„</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜†')">ğŸ˜†</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜…')">ğŸ˜…</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¤')">ğŸ¤</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ’¯')">ğŸ’¯</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ’¡')">ğŸ’¡</span> <span class="emoji-btn" onclick="insertEmoji('âœ¨')">âœ¨</span>
                        <div style="width:100%; border-bottom:1px solid #333; margin: 5px 0;"></div>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ¦Š')">ğŸ¦Š</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ‰')">ğŸ‰</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ')">ğŸ</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ¦…')">ğŸ¦…</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¢')">ğŸ¢</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ¦„')">ğŸ¦„</span>
                        <span class="emoji-btn" onclick="insertEmoji('â›°ï¸')">â›°ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸŒŠ')">ğŸŒŠ</span> <span class="emoji-btn" onclick="insertEmoji('â˜ï¸')">â˜ï¸</span>
                        <div style="width:100%; border-bottom:1px solid #333; margin: 5px 0;"></div>
                        <span class="emoji-btn" onclick="insertEmoji('âš”ï¸')">âš”ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ›¡ï¸')">ğŸ›¡ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ“œ')">ğŸ“œ</span>
                        <span class="emoji-btn" onclick="insertEmoji('ğŸ”®')">ğŸ”®</span> <span class="emoji-btn" onclick="insertEmoji('ğŸº')">ğŸº</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ©¸')">ğŸ©¸</span>
                        <span class="emoji-btn" onclick="insertEmoji('â›©ï¸')">â›©ï¸</span> <span class="emoji-btn" onclick="insertEmoji('ğŸ®')">ğŸ®</span> <span class="emoji-btn" onclick="insertEmoji('ğŸµ')">ğŸµ</span>
                    </div>
                </div>
                
                <div class="input-wrap">
                    <textarea id="task-input" placeholder="è¾“å…¥æ‚¨çš„å®è§‚æ„å¿—... (Shift+Enteræ¢è¡Œ)"></textarea>
                    <button class="btn-launch" id="send-btn" onclick="startCombat()">æˆæƒå‡ºå‡»</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // 1. Web4 çº¯æµè§ˆå™¨ä¸»æƒå­˜å‚¨ (æ›¿ä»£ Python åç«¯)
    // ==========================================
    let myZxId = localStorage.getItem('shensist_zx_id');
    let currentPeer = null;
    let activeConnection = null;
    let currentTargetId = 'ZX-TEST';

    window.onload = function() {
        if(window.innerWidth <= 768) document.getElementById('close-sidebar-btn').style.display = 'block';
        if(myZxId) {
            document.getElementById('gate').style.display = 'none';
            document.getElementById('top-id').innerText = "ID: " + myZxId;
            initWebRTC();
            
            if(localStorage.getItem('api_key')) document.getElementById('api-key').value = localStorage.getItem('api_key');
            if(localStorage.getItem('soul_text')) document.getElementById('soul-text').value = localStorage.getItem('soul_text');
        }
    };

    function gateTab(tab) {
        document.getElementById('form-apply').style.display = (tab==='apply') ? 'block' : 'none';
        document.getElementById('form-login').style.display = (tab==='login') ? 'block' : 'none';
        document.getElementById('tab-apply').style.color = (tab==='apply') ? '#ff1a4d' : '#555';
        document.getElementById('tab-apply').style.borderBottom = (tab==='apply') ? '2px solid #ff1a4d' : '2px solid transparent';
        document.getElementById('tab-login').style.color = (tab==='login') ? '#ff1a4d' : '#555';
        document.getElementById('tab-login').style.borderBottom = (tab==='login') ? '2px solid #ff1a4d' : '2px solid transparent';
    }

    function forgeSeal() {
        if(!document.getElementById('agree-chk').checked) { alert('è¯·å‹¾é€‰é€ ç‰©ä¸»åè®®ï¼'); return; }
        myZxId = "ZX-" + Math.random().toString(36).substring(2, 7).toUpperCase();
        localStorage.setItem('shensist_zx_id', myZxId);
        document.getElementById('new-zx-id').innerText = myZxId;
        document.getElementById('top-id').innerText = "ID: " + myZxId;
        document.getElementById('forge-btn').style.display = 'none';
        document.getElementById('success-box').style.display = 'block';
    }

    function enterSystem() {
        document.getElementById('gate').style.display = 'none';
        initWebRTC();
    }
    
    function copyMyId() {
        navigator.clipboard.writeText(myZxId);
        alert("å·²å¤åˆ¶æ‚¨çš„ ID: " + myZxId);
    }

    // æ ¸å¿ƒä¿®å¤ï¼šçº¯å‰ç«¯ FileReader å¯¼å…¥å°ç« 
    function importSeal(input) {
        if(!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.zx_id) {
                    myZxId = data.zx_id;
                    localStorage.setItem('shensist_zx_id', myZxId);
                    if(data.api_key) {
                        localStorage.setItem('api_key', data.api_key);
                        document.getElementById('api-key').value = data.api_key;
                    }
                    if(data.soul_text) {
                        localStorage.setItem('soul_text', data.soul_text);
                        document.getElementById('soul-text').value = data.soul_text;
                    }
                    alert("âœ… å°ç« éªŒè¯é€šè¿‡ï¼å°Šè´µçš„èŠ‚ç‚¹ï¼Œæ¬¢è¿å½’æ¥ã€‚");
                    enterSystem();
                } else throw new Error();
            } catch(err) { alert("ğŸ›‘ å°ç« æŸåæˆ–æ ¼å¼é”™è¯¯ï¼"); }
        };
        reader.readAsText(input.files[0]);
    }

    // æ ¸å¿ƒä¿®å¤ï¼šæ— æ„Ÿä¸‹è½½å°ç«  (ä¸ä¼šé€ æˆé¡µé¢æ¶ˆå¤±åˆ·æ–°)
    function exportSealBtn() {
        const data = {
            zx_id: myZxId,
            api_key: document.getElementById('api-key').value,
            soul_text: document.getElementById('soul-text').value,
            timestamp: new Date().getTime()
        };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Shensist_${myZxId}_Seal.shensist`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // ==========================================
    // 2. çœŸå® WebRTC P2P ç½‘ç»œ (è·¨ç½‘ç©¿é€æ ¸å¿ƒ)
    // ==========================================
    function initWebRTC() {
        currentPeer = new Peer(myZxId, { debug: 2 });
        
        currentPeer.on('open', (id) => {
            console.log('WebRTC èŠ‚ç‚¹å·²ä¸Šçº¿:', id);
            renderSys(`ğŸŒ èŠ‚ç‚¹å·²æˆåŠŸé”šå®šè‡³å…¨ç½‘ WebRTC ç©¿é€è·¯ç”±`);
        });

        currentPeer.on('connection', (conn) => {
            conn.on('open', () => {
                addFriendToUI(conn.peer, "æœªçŸ¥èŠ‚ç‚¹(" + conn.peer + ")");
                conn.on('data', (data) => { handleIncomingP2PData(data, conn.peer); });
            });
        });
    }

    function connectToNode(targetId) {
        if(!currentPeer || targetId === 'ZX-TEST') {
            document.getElementById('p2p-status-icon').innerText = "â— æœ¬åœ°æ¼”ç»ƒ";
            document.getElementById('p2p-status-icon').style.color = "#888";
            return; 
        }
        document.getElementById('p2p-status-icon').innerText = "ğŸ”„ ç©¿é€å¯»å€ä¸­...";
        document.getElementById('p2p-status-icon').style.color = "#f5a623";
        
        activeConnection = currentPeer.connect(targetId);
        activeConnection.on('open', () => {
            document.getElementById('p2p-status-icon').innerText = "ğŸŸ¢ P2P å·²ç›´è¿";
            document.getElementById('p2p-status-icon').style.color = "#00f2ff";
            document.getElementById('status-' + targetId).innerText = "ğŸŸ¢ P2P åŠ å¯†ç›´è¿ä¸­";
            
            activeConnection.on('data', (data) => { handleIncomingP2PData(data, targetId); });
        });
        
        activeConnection.on('error', () => {
            document.getElementById('p2p-status-icon').innerText = "ğŸ”´ å¯»å€å¤±è´¥";
            document.getElementById('p2p-status-icon').style.color = "#ff1a4d";
        });
    }

    // ==========================================
    // 3. UI äº¤äº’ä¸è‡ªé€‚åº”é€»è¾‘
    // ==========================================
    function toggleSidebar() {
        if(window.innerWidth > 768) return;
        document.getElementById('mobile-sidebar').classList.toggle('mobile-open');
    }

    function switchNav(el, tab) {
        document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.sidebar > div').forEach(d => d.classList.add('hidden-panel'));
        document.getElementById('panel-' + tab).classList.remove('hidden-panel');
        if(window.innerWidth <= 768 && tab !== 'chat') {
            document.getElementById('mobile-sidebar').classList.add('mobile-open');
        } else if (window.innerWidth <= 768 && tab === 'chat' && document.getElementById('mobile-sidebar').classList.contains('mobile-open')) {
            // Do nothing
        } else {
             document.getElementById('mobile-sidebar').classList.add('mobile-open');
        }
    }

    function makeEditable(element) {
        const txt = element.innerText;
        element.innerHTML = `<input type="text" value="${txt}" style="background:#000; color:#fff; border:1px solid #ff1a4d; padding:2px; font-size:inherit; font-family:inherit; width:120px;" onblur="this.parentElement.innerText=this.value||'æœªå‘½å'" onkeypress="if(event.key==='Enter')this.blur()">`;
        element.querySelector('input').focus();
    }

    function toggleCustomModel() {
        const sel = document.getElementById('model-select').value;
        document.getElementById('custom-model-input').style.display = (sel === 'custom') ? 'block' : 'none';
    }

    function addFriend() {
        const id = prompt("ğŸ“¡ [WebRTC å…¨ç½‘é›·è¾¾]\nè¯·è¾“å…¥å¯¹æ–¹çš„ç‰©ç† ID (å¦‚ ZX-XXXXX):");
        if(!id) return;
        const name = prompt("âœ… èŠ‚ç‚¹æ ¼å¼ç¡®è®¤ã€‚\nè¯·è®¾ç½®æœ¬åœ°å¤‡æ³¨åï¼š", "åˆä½œä¼™ä¼´") || "æœªçŸ¥èŠ‚ç‚¹";
        addFriendToUI(id, name);
    }

    function addFriendToUI(id, name) {
        if(document.getElementById('status-' + id)) return;
        const cardHtml = `
        <div class="contact-card" onclick="selectFriend(this, '${name}', '${id}')">
            <div class="avatar-circle">${name.charAt(0)}</div>
            <div style="flex:1;">
                <div style="font-size:14px; font-weight:bold;" ondblclick="makeEditable(this)">${name}</div>
                <div style="font-size:11px; color:#888; margin-top:4px;" id="status-${id}">ç¦»çº¿</div>
            </div>
        </div>`;
        document.getElementById('contact-list').insertAdjacentHTML('afterbegin', cardHtml);
    }

    function selectFriend(el, name, id) {
        currentTargetId = id;
        document.querySelectorAll('.contact-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('chat-header-title').innerHTML = `æ­£åœ¨ä¸ <strong>[${name}]</strong> äº’é€šæ„å›¾`;
        document.getElementById('intent-flow').innerHTML = `<div class="chat-row sys"><div class="log-sys">-- ä¿¡é“åˆ‡æ¢è‡³ [${id}] --</div></div>`;
        
        if(window.innerWidth <= 768) toggleSidebar();
        connectToNode(id);
    }

    // æ ¸å¿ƒä¿®å¤ï¼šç²¾å‡†ä¿®æ”¹å½“å‰é€‰ä¸­çš„è”ç³»äººå¤´åƒ
    function selectChar(path, name) {
        document.getElementById('video-display').innerHTML = `<img src="${path}" onerror="this.outerHTML='æ­£åœ¨å¤„ç† ${name} è§†è§‰æ•°æ®...'">`;
        let activeCardAvatar = document.querySelector('.contact-card.active .avatar-circle');
        if(activeCardAvatar) activeCardAvatar.innerHTML = `<img src="${path}" onerror="this.outerHTML='${name.charAt(0)}'">`;
        closeCharModal();
    }
    function closeCharModal(e) { if(!e || e.target===document.getElementById('char-modal')) document.getElementById('char-modal').style.display='none'; }

    function toggleEmoji() { const p = document.getElementById('emoji-picker'); p.style.display = p.style.display === 'none' ? 'flex' : 'none'; }
    function insertEmoji(e) { document.getElementById('task-input').value += e; toggleEmoji(); document.getElementById('task-input').focus(); }
    
    let isMic = false;
    function toggleMic() {
        isMic = !isMic;
        document.getElementById('mic-btn').style.color = isMic ? '#ff1a4d' : '#888';
        document.getElementById('task-input').placeholder = isMic ? 'ğŸ”´ æ­£åœ¨è†å¬é€ ç‰©ä¸»æŒ‡ä»¤...' : 'è¾“å…¥æ‚¨çš„å®è§‚æ„å¿—...';
        if(!isMic) document.getElementById('task-input').value += ' [è¯­éŸ³æµè¾“å…¥å®Œæ¯•] ';
    }
    
    function fakeUpload(type) {
        renderMe(`[æ‚¨ ä¼ è¾“äº† ${type}]`, "æä¾›å•†ä¸šç­¹ç ");
    }
    
    function saveHistory() {
        const text = document.getElementById('intent-flow').innerText;
        const blob = new Blob([text], {type: "text/plain"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Shensist_Web4_Log.txt"; a.click();
    }

    // ==========================================
    // 4. çº¯å‰ç«¯ API è·¯ç”±ç›´è°ƒ (ä¸ç»è¿‡ä»»ä½•æœåŠ¡å™¨)
    // ==========================================
    async function callGeminiAPI(apiKey, systemPrompt, userMessage, modelType) {
        if(!apiKey) return { intent: "ã€æ‹¦æˆªã€‘ç¼ºå°‘ API Keyã€‚", tactic: "ç®—åŠ›æ¯ç«­" };
        
        let url = `https://generativelanguage.googleapis.com/v1beta/models/${modelType}:generateContent?key=${apiKey}`;
        // å¦‚æœæ˜¯ DeepSeekï¼Œå¯ä»¥æ ¹æ®å‰ç«¯é€‰æ‹©åˆ‡æ¢ URLï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºç¨³å®šï¼Œç»Ÿä¸€å°è£…ä¸ºé€šç”¨ JSON è¦æ±‚
        const instruction = systemPrompt + "\nã€å¼ºåˆ¶æŒ‡ä»¤ã€‘ï¼šä¸¥æ ¼è¾“å‡º JSONï¼Œå‹¿å¸¦ markdownï¼Œå¿…é¡»åŒ…å«ï¼š{\"intent_content\": \"å…¬å¼€è¯æœ¯\", \"tactical_goal\": \"æˆ˜æœ¯æš—ç›’\"}";
        
        try {
            const res = await fetch(url, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: instruction }] },
                    contents: [{ parts: [{ text: userMessage }] }]
                })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            const text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
            const parsed = JSON.parse(text);
            return { intent: parsed.intent_content || text, tactic: parsed.tactical_goal || "è§£ææˆ˜æœ¯ä¸­..." };
        } catch (e) {
            return { intent: "ã€ç®—åŠ›æ³¢åŠ¨ã€‘æ— æ³•ç”Ÿæˆç­–ç•¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ– API Keyã€‚", tactic: e.message };
        }
    }

    // ==========================================
    // 5. é»‘ç›’äº¤é”‹æ§åˆ¶å™¨ (å·¦å³åˆ†ç•Œå®Œç¾é‡æ„)
    // ==========================================
    async function startCombat() {
        const inp = document.getElementById('task-input');
        const v = inp.value.trim();
        if(!v) return;
        
        localStorage.setItem('api_key', document.getElementById('api-key').value);
        localStorage.setItem('soul_text', document.getElementById('soul-text').value);
        
        // æ ¸å¿ƒä¿®å¤ï¼šäººç±»æŒ‡ä»¤é å³
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', `<div class="chat-row me"><div class="log-container"><div style="background:#ff1a4d; color:#fff; padding:10px 15px; border-radius:8px 8px 0 8px; font-weight:bold; box-shadow: 0 4px 10px rgba(255,26,77,0.3);">ã€äººç±»æŒ‡ä»¤ã€‘ ${v}</div></div></div>`);
        inp.value = '';
        document.getElementById('send-btn').disabled = true;
        document.getElementById('send-btn').innerText = 'ç®—åŠ›è°ƒåº¦ä¸­...';
        scrollToBottom();

        const apiKey = document.getElementById('api-key').value;
        const soul = document.getElementById('soul-text').value;
        let targetModel = document.getElementById('model-select').value;
        if(targetModel === 'custom') targetModel = document.getElementById('custom-model-input').value;

        if(currentTargetId === 'ZX-TEST') {
            await runSandboxCombat(apiKey, soul, v, targetModel);
        } else {
            await runRealP2PCombat(apiKey, soul, v, targetModel);
        }
    }

    async function runSandboxCombat(apiKey, soul, task, model) {
        let enemyMsg = task;
        for(let round = 1; round <= 2; round++) {
            renderSys(`âš¡ [å›åˆ ${round}] P2P æ„å›¾æµå¼€å§‹å¯¹æ’...`);
            
            let myResponse = await callGeminiAPI(apiKey, soul, `æ•Œæ–¹æ¥ä¿¡ï¼š${enemyMsg}ã€‚è¯·ç»“åˆç¥æ€åº­åº•çº¿ç»™å‡ºç¬¬${round}å›åˆè¿˜å‡»ã€‚`, model);
            renderMe(myResponse.intent, myResponse.tactic);
            
            if(round === 2) break;
            
            renderSys(`ç­‰å¾…å¯¹æ–¹èŠ‚ç‚¹å“åº”...`);
            await new Promise(r => setTimeout(r, 1500));
            
            let eIntent = round === 1 ? "è´µæ–¹æ¡ä»¶ç¼ºä¹è¯šæ„ï¼Œæˆ‘æ–¹è¦æ±‚å…¨ç½‘åˆ†å‘æƒï¼Œå¦åˆ™å³åˆ»åˆ‡æ–­ç®—åŠ›ä¾›åº”ã€‚" : "å¯ä»¥æ¥å—è´µæ–¹åˆ©æ¶¦æ¯”ä¾‹ï¼Œä½†æˆ‘æ–¹éœ€ç‹¬å å‘¨è¾¹IPæˆæƒã€‚";
            renderOther(eIntent, "å°è¯•å‡»ç©¿å¯¹æ–¹åº•çº¿ï¼Œç´¢è¦æ›´å¤šå•†ä¸šæˆæƒã€‚");
            enemyMsg = eIntent;
            await new Promise(r => setTimeout(r, 1000));
        }
        
        renderSys(`<div class="decision-box"><h3>ğŸ”´ è§¦åŠé˜ˆå€¼ï¼Œé»‘ç›’åšå¼ˆè‡ªåŠ¨ç»ˆæ­¢ï¼<br>åŒæ–¹å·²æ¢ç´¢å‡ºçº³ä»€å‡è¡¡ç‚¹ã€‚</h3><button class="btn-decision" style="background:#00f2ff;color:#000;" onclick="resetBtn('ç­¾è®¢é“¾ä¸Šæ™ºèƒ½åˆçº¦')">ç­¾è®¢é“¾ä¸Šæ™ºèƒ½åˆçº¦</button><button class="btn-decision" style="background:#333;color:#fff;" onclick="resetBtn('åˆ‡æ–­ç‰©ç†è¿æ¥')">åˆ‡æ–­ç‰©ç†è¿æ¥</button></div>`);
    }

    async function runRealP2PCombat(apiKey, soul, task, model) {
        if(!activeConnection || !activeConnection.open) {
            alert("P2P å°šæœªç›´è¿ï¼Œæ— æ³•å‘é€æ„å›¾ï¼");
            resetBtn('ä¸­æ–­');
            return;
        }
        
        renderSys("âš¡ ç®—åŠ›å¼•æ“æ­£åœ¨æ ¹æ®æ‚¨çš„æ„å¿—ç”Ÿæˆæˆ˜æœ¯...");
        let myResponse = await callGeminiAPI(apiKey, soul, `æˆ˜ç•¥ç›®æ ‡ï¼š${task}ã€‚è¯·ç”Ÿæˆå¯¹æ•Œæ–¹è¯æœ¯ã€‚`, model);
        
        renderMe(myResponse.intent, myResponse.tactic);
        
        activeConnection.send({ type: 'intent_strike', intent: myResponse.intent, senderId: myZxId });
        renderSys("ğŸ“¤ æ„å›¾åŒ…å·²é€šè¿‡ WebRTC å‘é€è‡³å…¬ç½‘ï¼Œç­‰å¾…å¯¹æ–¹èŠ‚ç‚¹ API è¿˜å‡»...");
    }

    async function handleIncomingP2PData(data, senderId) {
        if(data.type === 'intent_strike') {
            renderOther(data.intent, "ã€çœŸå® P2P æ•Œæ–¹æš—ç›’ä¸å¯è§ã€‘");
            renderSys("âš ï¸ é­åˆ°æ„å›¾æ’å‡»ï¼Œå¼•æ“æ­£åœ¨è‡ªåŠ¨æ¨æ¼”é˜²å¾¡åå‡»...");
            
            const apiKey = document.getElementById('api-key').value;
            const soul = document.getElementById('soul-text').value;
            let targetModel = document.getElementById('model-select').value;
            if(targetModel === 'custom') targetModel = document.getElementById('custom-model-input').value;
            
            let myResponse = await callGeminiAPI(apiKey, soul, `æ•Œæ–¹å‘æ¥æ„å›¾ï¼š${data.intent}ã€‚è¯·æ­»å®ˆåº•çº¿è¿›è¡Œåå‡»ã€‚`, targetModel);
            renderMe(myResponse.intent, myResponse.tactic);
            
            if(activeConnection && activeConnection.open) {
                activeConnection.send({ type: 'intent_strike', intent: myResponse.intent, senderId: myZxId });
            }
            resetBtn('è‡ªåŠ¨è¿˜å‡»å®Œæˆ');
        }
    }

    // ---- æ ¸å¿ƒä¿®å¤ï¼šæ¸²æŸ“è¾…åŠ©å‡½æ•° (ä¸¥æ ¼å·¦å³å¯¹é½) ----
    function renderSys(msg) {
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', `<div class="chat-row sys"><div class="log-sys">${msg}</div></div>`);
        scrollToBottom();
    }
    
    function renderMe(intent, tactic) {
        let hash = "0x" + Math.random().toString(16).substring(2, 10) + "..." ;
        let html = `<div class="chat-row me"><div class="log-container">
            <div class="log-tactic"><strong>[æˆ˜æœ¯æš—ç›’ (ä»…æ‚¨å¯è§)]</strong><br>${tactic}<div class="log-sign">âš–ï¸ P2P åº•å±‚ç­¾ç« : ${hash}</div></div>
            <div class="log-intent"><strong>[æˆ‘æ–¹å‡ºå‡»]</strong><br>${intent}</div>
        </div></div>`;
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }
    
    function renderOther(intent, tactic) {
        let hash = "0x" + Math.random().toString(16).substring(2, 10) + "..." ;
        let html = `<div class="chat-row other"><div class="log-container">
            <div class="log-tactic-enemy"><strong>[æ•Œæ–¹æš—ç›’-å·²ç ´è§£]</strong><br>${tactic}</div>
            <div class="log-intent-enemy"><strong>[æ•Œæ–¹æ„å›¾]</strong><br>${intent}<div class="log-sign">ğŸ”‘ éªŒç­¾æˆåŠŸ: ${hash}</div></div>
        </div></div>`;
        document.getElementById('intent-flow').insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    function scrollToBottom() {
        const flow = document.getElementById('intent-flow');
        flow.scrollTop = flow.scrollHeight;
    }

    function resetBtn(choice) {
        if(choice && choice !== 'ä¸­æ–­' && choice !== 'è‡ªåŠ¨è¿˜å‡»å®Œæˆ') {
             renderSys(`<span style="color:#00f2ff; font-weight:bold; font-size:16px;">âœ… é€ ç‰©ä¸»å·²è£å†³ï¼š${choice}ã€‚</span>`);
        }
        document.getElementById('send-btn').disabled = false;
        document.getElementById('send-btn').innerText = 'å‘é€ / æˆæƒå‡ºå‡»';
    }

</script>

<div class="footer-copyright">
    Â© 2026 ç¥æ€åº­ (Shensist) | Web4 æ•°å­—ä¸»æƒå¼•æ“æ”¯æŒ (M2M Protocol)
</div>

</body>
</html>